<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Packeton Docs</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="index.html">Overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Setup</li><li class="chapter-item expanded "><a href="installation.html">Installation</a></li><li class="chapter-item expanded "><a href="installation-docker.html">Using docker</a></li><li class="chapter-item expanded "><a href="reverse-proxy.html">Using a reverse proxy</a></li><li class="chapter-item expanded affix "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="usage/index.html">Administration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/api.html">Admin API</a></li><li class="chapter-item expanded "><a href="webhook.html">Outgoing Webhook</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="webhook.html">Intro</a></li><li class="chapter-item expanded "><a href="webhook.html">Examples</a></li><li class="chapter-item expanded "><a href="webhook/webhook-secrets.html">Secrets</a></li><li class="chapter-item expanded "><a href="webhook/wh-security.html">Security Policy</a></li><li class="chapter-item expanded "><a href="webhook/wh-test.html">Testing</a></li></ol></li><li class="chapter-item expanded "><a href="usage/update-packages.html">Update Webhooks</a></li><li class="chapter-item expanded "><a href="usage/customers.html">Customer Users</a></li><li class="chapter-item expanded "><a href="usage/credential.html">SSH Credential</a></li><li class="chapter-item expanded "><a href="usage/mirroring.html">Mirroring Packages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usage/mirroring.html">Configuration</a></li><li class="chapter-item expanded "><a href="usage/mirroring.html">Strict mode</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="authentication.html">User Authentication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="authentication-jwt.html">JWT Configuration</a></li><li class="chapter-item expanded "><a href="authentication-ldap.html">LDAP Configuration</a></li></ol></li><li class="chapter-item expanded "><a href="usage/storage.html">S3 Storage Provider</a></li><li class="chapter-item expanded "><a href="usage/custom-page.html">Custom landing page</a></li><li class="chapter-item expanded "><a href="usage/security-monitoring.html">Security Monitoring</a></li><li class="chapter-item expanded "><a href="usage/migrate.html">Migrate from Satis</a></li><li class="chapter-item expanded "><a href="oauth2.html">OAuth2 Integrations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pull-request-review.html">Pull Request review</a></li><li class="chapter-item expanded "><a href="oauth2/github-oauth.html">GitHub Setup</a></li><li class="chapter-item expanded "><a href="oauth2/githubapp.html">GitHub AppBot</a></li><li class="chapter-item expanded "><a href="oauth2/gitlab-integration.html">GitLab Setup</a></li><li class="chapter-item expanded "><a href="oauth2/gitea.html">Gitea Setup</a></li><li class="chapter-item expanded "><a href="oauth2/bitbucket.html">Bitbucket Setup</a></li><li class="chapter-item expanded "><a href="oauth2/login-expression.html">Login Restriction</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Development</li><li class="chapter-item expanded "><a href="dev/CONTRIBUTING.html">Contributing</a></li><li class="chapter-item expanded "><a href="dev/configuration.html">Configuration Reference</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Packeton Docs</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/vtsykun/packeton" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Packeton - Private PHP package repository for vendors. <a href="https://github.com/vtsykun/packeton">GitHub Source Code</a></p>
<p><strong>Documentation</strong> <a href="https://docs.packeton.org">docs.packeton.org</a></p>
<h2 id="main-features"><a class="header" href="#main-features">Main Features</a></h2>
<ul>
<li>Compatible with Composer API v2, bases on Symfony 6.</li>
<li>Support update webhook for GitHub, Gitea, Bitbucket and GitLab or custom format.</li>
<li>Customers user and ACL groups and limit access by vendor and versions.</li>
<li>Composer Proxies and Mirroring.</li>
<li>Generic Packeton <a href="webhook.html">webhooks</a></li>
<li>Allow to freeze updates for the new releases after expire a customers license.</li>
<li>Mirroring for packages zip files and downloads it's from your host.</li>
<li>Credentials and Authentication http-basic config or ssh keys.</li>
<li>Support monolithic repositories, like <code>symfony/symfony</code></li>
<li>Pull Request <code>composer.lock</code> change review.</li>
<li>OAuth2 GitHub, Bitbucket, GitLab/Gitea and Other Integrations.</li>
<li>Security Monitoring.</li>
<li>Milty sub repositories.</li>
</ul>
<h2 id="compare-private-packagist-with-packeton"><a class="header" href="#compare-private-packagist-with-packeton">Compare Private Packagist with Packeton</a></h2>
<div class="table-wrapper"><table><thead><tr><th><em>Feature</em></th><th><em>Packeton</em></th><th><em>Packagist.com</em></th></tr></thead><tbody>
<tr><td>Composer API</td><td>v1, v2</td><td>v1, v2</td></tr>
<tr><td>REST API</td><td>Partial covered. Only main CRUD feature</td><td>Full covered. +PHP SDK private-packagist-api-client</td></tr>
<tr><td>Custom User/Vendors</td><td>Limit access by versions, packages, release date. Customer users and groups</td><td>Limit access by versions, packages, stability. Users and Vendors bundles</td></tr>
<tr><td>Statistics</td><td>Default by versions, packages</td><td>By versions, packages and customer usage</td></tr>
<tr><td>Integrations</td><td>GitHub, GitLab, Gitea, Bitbucket</td><td>GitHub, GitLab, Bitbucket (cloud/ server), AWS CodeCommit, Azure DevOps</td></tr>
<tr><td>Synchronization</td><td>Only Repositories</td><td>Teams, Permissions and Repositories</td></tr>
<tr><td>Pull request review</td><td>GitHub, GitLab, Gitea, Bitbucket</td><td>Integrations - GitHub, GitLab, Bitbucket (cloud/ server)</td></tr>
<tr><td>Fine-grained API Token</td><td>Support</td><td>-</td></tr>
<tr><td>Mirroring</td><td>Full Support. Separate URL path to access the repo</td><td>Full Support. Automatically setup</td></tr>
<tr><td>Patch Mirroring metadata</td><td>Support. UI metadata manager</td><td>-</td></tr>
<tr><td>Incoming webhooks</td><td>Support. Full compatibility with packagist.org and its integrations</td><td>Support. Used unique uuid address</td></tr>
<tr><td>Outgoing webhooks</td><td>Full Support. Custom UI request builder with expressions</td><td>Support. Request payload format is not configurable</td></tr>
<tr><td>Subrepositories</td><td>Support</td><td>Support</td></tr>
<tr><td>LDAP</td><td>Support. On config level</td><td>Support</td></tr>
<tr><td>Dependency License Review</td><td>-</td><td>Support</td></tr>
<tr><td>Security Monitoring</td><td>Support. Webhook notifications</td><td>Support. Webhook/email notifications</td></tr>
<tr><td>Patch requires/metadata</td><td>Support. UI metadata manager</td><td>-</td></tr>
<tr><td>Repos type</td><td>VCS (auto), Mono-repo, Custom JSON, Artifacts</td><td>VCS, Githib/GitLab/Bitbucket, Custom JSON, Artifacts, Import Satis</td></tr>
<tr><td>Mono-repo support</td><td>Support</td><td>Support</td></tr>
<tr><td>Import</td><td>VCS Integration / Satis / Packagist.com  / List repos</td><td>Satis</td></tr>
<tr><td>Pricing</td><td>Open Source. Free</td><td>€5900 or €49/user/month</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h2 id="install-and-run"><a class="header" href="#install-and-run">Install and Run</a></h2>
<p>There is an official packeton image available at <a href="https://hub.docker.com/r/packeton/packeton">https://hub.docker.com/r/packeton/packeton</a>
which can be used with the docker-compose file, see <a href="installation-docker.html">docker installation</a></p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<h3 id="requirements"><a class="header" href="#requirements">Requirements</a></h3>
<ul>
<li>PHP 8.1+</li>
<li>Redis for some functionality (favorites, download statistics, worker queue).</li>
<li>git/svn/hg depending on which repositories you want to support.</li>
<li>Supervisor to run a background job worker</li>
<li>(optional) MySQL or PostgresSQL for the main data store, default SQLite</li>
</ul>
<ol>
<li>Clone the repository</li>
</ol>
<pre><code class="language-bash">git clone https://github.com/vtsykun/packeton.git /var/www/packeton/
cd /var/www/packeton/
</code></pre>
<ol start="2">
<li>Install dependencies <code>composer install</code></li>
<li>Create <code>.env.local</code> and copy needed environment variables into it. See <a href="installation.html#configuration">Configuration</a> </li>
<li>IMPORTANT! Don't forget change <code>APP_SECRET</code></li>
<li>Run <code>bin/console doctrine:schema:update --force --complete</code> to setup the DB</li>
<li>Create admin user via console.</li>
</ol>
<pre><code class="language-bash">php bin/console packagist:user:manager username --email=admin@example.com --password=123456 --admin 
</code></pre>
<ol start="7">
<li>Setup nginx or any webserver, for example nginx config looks like.</li>
</ol>
<pre><code>server {
    listen *:443 ssl http2;
    server_name packeton.example.org;
    root /var/www/packeton/public;

    ssl_certificate /etc/nginx/ssl/example.crt;
    ssl_certificate_key /etc/nginx/ssl/example.key;

    ssl_ciphers 'TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-256-GCM-SHA384:ECDHE:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4';

    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_session_timeout  5m;

    rewrite ^/index\.php/?(.+)$ /$1 permanent;
    try_files $uri @rewriteapp;

    location @rewriteapp {
        rewrite ^(.*)$ /index.php/$1 last;
    }

    access_log off;

    location ~ ^/index\.php(/|$) {
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_index index.php;
        send_timeout 300;
        fastcgi_read_timeout 300;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
    }
}
</code></pre>
<ol start="8">
<li>Change cache permission to made it accessible for web server.</li>
</ol>
<pre><code class="language-bash">chown www-data:www-data -R var/
</code></pre>
<ol start="9">
<li>
<p>If you get a 500 error in index page <code>packeton.example.org</code>, please check your logs <code>var/log/prod.log</code> or/and webserver log
and fix permissions, database config, redis etc.</p>
</li>
<li>
<p>Enable cron tabs and background jobs.</p>
</li>
</ol>
<p>Enable crontab <code>crontab -e -u www-data</code></p>
<pre><code>* * * * * /var/www/packeton/bin/console --env=prod okvpn:cron &gt;&gt; /dev/null
</code></pre>
<p><strong>Setup Supervisor to run worker</strong></p>
<pre><code class="language-bash">sudo apt -y --no-install-recommends install supervisor
</code></pre>
<p>Create a new supervisor configuration.</p>
<pre><code class="language-bash">sudo vim /etc/supervisor/conf.d/packagist.conf
</code></pre>
<p>Add the following lines to the file.</p>
<pre><code>[program:packeton-workers]
environment =
        HOME=/var/www/
command=/var/www/packeton/bin/console packagist:run-workers
directory=/var/www/packeton/
process_name=%(program_name)s_%(process_num)02d
numprocs=1
autostart=true
autorestart=true
startsecs=0
redirect_stderr=true
priority=1
user=www-data
</code></pre>
<h3 id="configuration"><a class="header" href="#configuration">Configuration</a></h3>
<p>Create a file <code>.env.local</code> and change next options</p>
<ul>
<li><code>APP_SECRET</code> - Must be static, used for encrypt SSH keys in database.</li>
<li><code>APP_COMPOSER_HOME</code> - composer home, default <code>/var/www/packeton/var/.composer/</code></li>
<li><code>DATABASE_URL</code> - Database DSN, default sqlite:///%kernel.project_dir%/var/app.db</li>
</ul>
<p>Example for postgres <code>postgresql://app:pass@127.0.0.1:5432/app?serverVersion=14&amp;charset=utf8</code>
Example for mysql <code>mysql://app:!ChangeMe!@127.0.0.1:3306/app?serverVersion=8&amp;charset=utf8mb4</code></p>
<pre><code># .env.local

DATABASE_URL=&quot;postgresql://app:!ChangeMe!@127.0.0.1:5432/app?serverVersion=14&amp;charset=utf8&quot;
</code></pre>
<ul>
<li><code>PACKAGIST_DIST_PATH</code> - Default <code>%kernel.project_dir%/var/zipball</code>, path to storage zipped artifacts </li>
<li><code>REDIS_URL</code> - Redis DB, default <code>redis://localhost</code></li>
<li><code>PACKAGIST_DIST_HOST</code> - Hostname, (auto) default use the current host header in the request.</li>
<li><code>TRUSTED_PROXIES</code> - Ips for Reverse Proxy. See <a href="https://symfony.com/doc/current/deployment/proxies.html">Symfony docs</a></li>
<li><code>PUBLIC_ACCESS</code> - Allow anonymous users access to read packages metadata, default: <code>false</code></li>
<li><code>MAILER_DSN</code> - Mailer for reset password, default disabled</li>
<li><code>MAILER_FROM</code> - Mailer from</li>
</ul>
<h3 id="ssh-key-access-and-composer-oauth-token"><a class="header" href="#ssh-key-access-and-composer-oauth-token">Ssh key access and composer oauth token.</a></h3>
<p>Packagist uses the composer config and global ssh-key to get read access to your repositories, so
the supervisor worker <code>packagist:run-workers</code> and web-server must run under the user,
that have ssh key or composer config that gives it read (clone) access to your git/svn/hg repositories.
For example, if your application runs under <code>www-data</code> and have home directory <code>/var/www</code>, directory
structure must be like this.</p>
<pre><code>    └── /var/www/
        └── .ssh/ # ssh keys directory
            ├── config
            ├── id_rsa # main ssh key
            ├── private_key_2 # additional ssh key
            └── private_key_3
        └── packeton/ # project dir
            ├── config APP_COMPOSER_HOME=&quot;%kernel.project_dir%/var/.composer&quot;
            ├── public 
            ....
            ├── src 
            └── var
                ├── cache
                ....
                └── .composer # APP_COMPOSER_HOME=&quot;%kernel.project_dir%/var/.composer&quot;
</code></pre>
<p>By default, composer configuration load from <code>COMPOSER_HOME</code> and it placed at path <code>%kernel.project_dir%/var/.composer</code>.
if you want to setup authentication in <code>auth.json</code> need to place this file to composer home, i e. <code>/var/www/packeton/var/.composer/</code>
See <a href="https://getcomposer.org/doc/articles/authentication-for-private-packages.md#authentication-in-auth-json-per-project">Authentication in auth.json</a></p>
<pre><code># Example /var/www/packeton/var/.composer/auth.json
{ 
  &quot;http-basic&quot;: {
    &quot;git.example.pl&quot;: {
      &quot;username&quot;: &quot;kastus&quot;,
      &quot;password&quot;: &quot;489df705a503ac0173256ce01f&quot;
    }
  }
}
</code></pre>
<p>Example ssh config for multiple SSH Keys for different github account/repos,
see <a href="https://gist.github.com/jexchan/2351996">here for details</a></p>
<pre><code># ~/.ssh/config - example

Host github-oroinc
	HostName github.com
	User git
	IdentityFile /var/www/.ssh/private_key_2
	IdentitiesOnly yes

Host github-org2
	HostName github.com
	User git
	IdentityFile /var/www/.ssh/private_key_3
	IdentitiesOnly yes

</code></pre>
<h4 id="allow-connections-to-http"><a class="header" href="#allow-connections-to-http">Allow connections to http.</a></h4>
<p>You can create <code>config.json</code> in the composer home (see <code>APP_COMPOSER_HOME</code> env var) or add this option
in the UI credentials form.</p>
<pre><code class="language-json">{
    &quot;secure-http&quot;: false
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="install-and-run-in-docker"><a class="header" href="#install-and-run-in-docker">Install and Run in Docker</a></h2>
<p>You can use prebuild <a href="https://hub.docker.com/r/packeton/packeton">packeton/packeton</a> image</p>
<h2 id="quick-start"><a class="header" href="#quick-start">Quick start</a></h2>
<pre><code>docker run -d --name packeton \
    --mount type=volume,src=packeton-data,dst=/data \
    -p 8080:80 \
    packeton/packeton:latest
</code></pre>
<p>After container is running, you may wish to create an admin user via command <code>packagist:user:manager</code></p>
<pre><code>docker exec -it packeton bin/console packagist:user:manager admin --password=123456 --admin
</code></pre>
<h2 id="docker-environment"><a class="header" href="#docker-environment">Docker Environment</a></h2>
<p>All env variables is optional. By default, Packeton uses an SQLite database and build-in redis service,
but you can overwrite it by env REDIS_URL and DATABASE_URL. The all app data is stored in the VOLUME /data</p>
<ul>
<li>
<p><code>APP_SECRET</code> - Must be static, used for encrypt SSH keys in database. The value is generated automatically, see <code>.env</code> in the data volume.</p>
</li>
<li>
<p><code>APP_COMPOSER_HOME</code> - composer home, default /data/composer</p>
</li>
<li>
<p><code>DATABASE_URL</code> - Database DSN, default sqlite:////data/app.db. Example for postgres &quot;postgresql://app:pass@127.0.0.1:5432/app?serverVersion=14&amp;charset=utf8&quot;</p>
</li>
<li>
<p><code>PACKAGIST_DIST_PATH</code> - Default /data/zipball, path to storage zipped versions</p>
</li>
<li>
<p><code>REDIS_URL</code> - Redis DB, default redis://localhost</p>
</li>
<li>
<p><code>PACKAGIST_DIST_HOST</code> - Hostname, (auto) default use the current host header in the request.
Overwrite packagist host (example https://packagist.youcomany.org). Used for downloading the mirroring zip packages. 
(The host add into dist url for composer metadata). The default value is define dynamically from the header Host.</p>
</li>
<li>
<p><code>TRUSTED_PROXIES</code> - Ips for Reverse Proxy. See <a href="https://symfony.com/doc/current/deployment/proxies.html">Symfony docs</a></p>
</li>
<li>
<p><code>PUBLIC_ACCESS</code> - Allow anonymous users access to read packages metadata, default: <code>false</code></p>
</li>
<li>
<p><code>MAILER_DSN</code> - Mailer for reset password, default disabled</p>
</li>
<li>
<p><code>MAILER_FROM</code> - Mailer from</p>
</li>
<li>
<p><code>ADMIN_USER</code> Creating admin account, by default there is no admin user created so you won't be able to login to 
the packagist. To create an admin account you need to use environment variables to pass 
in an initial username and password (<code>ADMIN_PASSWORD</code>, <code>ADMIN_EMAIL</code>).</p>
</li>
<li>
<p><code>ADMIN_PASSWORD</code> - used together with <code>ADMIN_USER</code></p>
</li>
<li>
<p><code>ADMIN_EMAIL</code> -  used together with <code>ADMIN_USER</code></p>
</li>
<li>
<p><code>PRIVATE_REPO_DOMAIN_LIST</code> - Save ssh fingerprints to known_hosts for this domain.</p>
</li>
</ul>
<h4 id="volume"><a class="header" href="#volume">VOLUME</a></h4>
<p>The all app data is stored in the VOLUME /data</p>
<h3 id="user-docker-compose"><a class="header" href="#user-docker-compose">User docker compose</a></h3>
<p>The typical example <code>docker-compose.yml</code></p>
<pre><code class="language-yaml">version: '3.6'

services:
    packeton:
        image: packeton/packeton:latest
        container_name: packeton
        hostname: packeton
        environment:
            ADMIN_USER: admin
            ADMIN_PASSWORD: 123456
            ADMIN_EMAIL: admin@example.com
            DATABASE_URL: mysql://app:!ChangeMe!@127.0.0.1:3306/app?serverVersion=8&amp;charset=utf8mb4
        ports:
            - '127.0.0.1:8080:80'
        volumes:
            - .docker:/data
</code></pre>
<p>By default, the container starts the supervisor, which is used to run other tasks: 
nginx, redis, php-fpm, cron, however, you can start one service per container. 
See docker-compose-prod.yml example:</p>
<pre><code class="language-yaml">version: '3.9'

x-volumes: &amp;default-volume
    volumes:
        - app-data:/data
        - app-var:/var/www/packagist/var

x-restart-policy: &amp;restart_policy
    restart: unless-stopped

x-environment: &amp;default-environment
    REDIS_URL: redis://redis
    DATABASE_URL: &quot;postgresql://packeton:pack123@postgres:5432/packeton?serverVersion=14&amp;charset=utf8&quot;
    SKIP_INIT: 1

services:
    redis:
        image: redis:7-alpine
        hostname: redis
        &lt;&lt;: *restart_policy
        volumes:
            - redis-data:/data
 
    postgres:
        image: postgres:14-alpine
        hostname: postgres
        &lt;&lt;: *restart_policy
        volumes:
            - postgres-data:/var/lib/postgresql/data
        environment:
            POSTGRES_USER: packeton
            POSTGRES_PASSWORD: pack123
            POSTGRES_DB: packeton

    php-fpm:
        image: packeton/packeton:latest
        hostname: php-fpm
        command: ['php-fpm', '-F']
        &lt;&lt;: *restart_policy
        &lt;&lt;: *default-volume
        environment:
            &lt;&lt;: *default-environment
            SKIP_INIT: 0
            WAIT_FOR_HOST: 'postgres:5432'
        depends_on:
            - &quot;postgres&quot;
            - &quot;redis&quot;

    nginx:
        image: packeton/packeton:latest
        hostname: nginx
        ports:
            - '127.0.0.1:8088:80'
        &lt;&lt;: *restart_policy
        &lt;&lt;: *default-volume
        command: &gt;
            bash -c 'sed s/_PHP_FPM_HOST_/php-fpm:9000/g &lt; docker/nginx/nginx-tpl.conf &gt; /etc/nginx/nginx.conf &amp;&amp; nginx'
        environment:
            &lt;&lt;: *default-environment
            WAIT_FOR_HOST: 'php-fpm:9000'
        depends_on:
            - &quot;php-fpm&quot;

    worker:
        image: packeton/packeton:latest
        hostname: packeton-worker
        command: ['bin/console', 'packagist:run-workers', '-v']
        user: www-data
        &lt;&lt;: *restart_policy
        &lt;&lt;: *default-volume
        environment:
            &lt;&lt;: *default-environment
            WAIT_FOR_HOST: 'php-fpm:9000'
        depends_on:
            - &quot;php-fpm&quot;

    cron:
        image: packeton/packeton:latest
        hostname: packeton-cron
        command: ['bin/console', 'okvpn:cron', '--demand', '--time-limit=3600']
        user: www-data
        &lt;&lt;: *restart_policy
        &lt;&lt;: *default-volume
        environment:
            &lt;&lt;: *default-environment
            WAIT_FOR_HOST: 'php-fpm:9000'
        depends_on:
            - &quot;php-fpm&quot;

volumes:
    redis-data:
    postgres-data:
    app-data:
    app-var:

</code></pre>
<h2 id="build-and-run-docker-container-with-docker-compose"><a class="header" href="#build-and-run-docker-container-with-docker-compose">Build and run docker container with docker-compose</a></h2>
<ol>
<li>Clone repository</li>
</ol>
<pre><code class="language-bash">git clone https://github.com/vtsykun/packeton.git /var/www/packeton/
cd /var/www/packeton/
</code></pre>
<ol start="2">
<li>Run <code>docker-compose build</code></li>
</ol>
<pre><code class="language-bash">docker-compose build

# start container.
docker-compose up -d # Run with single supervisor container 
docker-compose up -f docker-compose-prod.yml -d # Or split 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-a-reverse-proxy"><a class="header" href="#using-a-reverse-proxy">Using a reverse proxy</a></h1>
<p>It is recommended to put a reverse proxy such as nginx, Apache for docker installation.</p>
<h3 id="reverse-proxy-configuration-examples"><a class="header" href="#reverse-proxy-configuration-examples">Reverse-proxy configuration examples</a></h3>
<h4 id="nginx"><a class="header" href="#nginx">nginx</a></h4>
<pre><code>server {
    listen *:443 ssl http2;

    server_name pkg.example.gob.ar;

    ssl_certificate /etc/nginx/ssl/gob.ar.crt;
    ssl_certificate_key /etc/nginx/ssl/gob.ar.key;
    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4';

    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 16k;
    gzip_http_version 1.1;
    gzip_min_length 2048;
    gzip_types text/css application/javascript text/javascript application/json;
    access_log  off;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:8082/;
    }
}
</code></pre>
<h4 id="nginx-with-cloudflare"><a class="header" href="#nginx-with-cloudflare">nginx with cloudflare</a></h4>
<pre><code>server {
    listen *:80;

    server_name demo.packeton.org;

    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 16k;
    gzip_http_version 1.1;
    gzip_min_length 2048;
    gzip_types text/css application/javascript text/javascript application/json;

    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    real_ip_header CF-Connecting-IP;
    add_header Access-Control-Allow-Origin *;

    location / {
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Host $http_host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_pass http://127.0.0.1:8082/;
    }
}
</code></pre>
<h4 id="apache"><a class="header" href="#apache">Apache</a></h4>
<pre><code>&lt;VirtualHost *:443&gt;
    ServerName pack1.loc.example.ovh
    SSLEngine on
    SSLCertificateFile /etc/nginx/ssl/example.crt
    SSLCertificateKeyFile /etc/nginx/ssl/example.key

    Protocols h2 http/1.1
    ProxyRequests on
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8082/
    ProxyPassReverse / http://127.0.0.1:8082/

    SSLProxyEngine On
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    RequestHeader set &quot;X-Forwarded-Proto&quot; expr=%{REQUEST_SCHEME}
&lt;/VirtualHost&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="administration"><a class="header" href="#administration">Administration</a></h1>
<p>This section contains information on managing your Packeton application. </p>
<h2 id="table-of-content"><a class="header" href="#table-of-content">Table of content</a></h2>
<ul>
<li><a href="usage/api.html">API Usage</a></li>
<li><a href="usage/../webhook.html">Outgoing Webhook</a>
<ul>
<li><a href="usage/../webhook.html#introduction">Intro</a></li>
<li><a href="usage/../webhook.html#examples">Examples</a>
<ul>
<li><a href="usage/../webhook.html#telegram-notification">Telegram notification</a></li>
<li><a href="usage/../webhook.html#slack-notification">Slack notification</a></li>
<li><a href="usage/../webhook.html#jira-create-a-new-release-and-set-fix-version">JIRA issue fix version</a></li>
<li><a href="usage/../webhook.html#gitlab-auto-webhook">Gitlab setup auto webhook</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="usage/index.html#application-roles">Application Roles</a></li>
</ul>
<h2 id="application-roles"><a class="header" href="#application-roles">Application Roles</a></h2>
<ul>
<li><code>ROLE_USER</code> - minimal customer access level, these users only can read metadata only for selected packages.</li>
<li><code>ROLE_FULL_CUSTOMER</code> - Can read all packages metadata.</li>
<li><code>ROLE_MAINTAINER</code> -  Can submit a new package and read all metadata.</li>
<li><code>ROLE_ADMIN</code> - Can create a new customer users, management webhooks and credentials.</li>
</ul>
<p>You can create a user and then promote to admin or maintainer via console using fos user bundle commands.</p>
<pre><code>php bin/console packagist:user:manager username --email=admin@example.com --password=123456 --admin # create admin user
php bin/console packagist:user:manager user1 --add-role=ROLE_MAINTAINER # Add ROLE_MAINTAINER to user user1
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="api-documentation"><a class="header" href="#api-documentation">API documentation</a></h1>
<p>About API authorization methods see <a href="usage/../authentication.html#composer-api-authentication">here</a></p>
<h4 id="submit-package"><a class="header" href="#submit-package">Submit package</a></h4>
<pre><code>POST https://example.com/api/create-package?token=&lt;api_token&gt;
Content-Type: application/json

{
    &quot;repository&quot;: {
        &quot;url&quot;: &quot;git@github.com:symfony/mime.git&quot;
    }
}
</code></pre>
<h4 id="listing-package-names"><a class="header" href="#listing-package-names">Listing package names</a></h4>
<pre><code>GET https://example.com/packages/list.json?token=&lt;api_token&gt;

# Result
{
  &quot;packageNames&quot;: [
    &quot;[vendor]/[package]&quot;,
    ...
  ]
}
</code></pre>
<h4 id="list-packages-by-vendor"><a class="header" href="#list-packages-by-vendor">List packages by vendor</a></h4>
<pre><code>
GET https://example.com/packages/list.json?vendor=[vendor]&amp;token=&lt;api_token&gt;

{
  &quot;packageNames&quot;: [
    &quot;[vendor]/[package]&quot;,
    ...
  ]
}
</code></pre>
<h4 id="list-packages-by-type"><a class="header" href="#list-packages-by-type">List packages by type</a></h4>
<pre><code>GET https://example.com/packages/list.json?type=[type]&amp;token=&lt;api_token&gt;

{
  &quot;packageNames&quot;: [
    &quot;[vendor]/[package]&quot;,
    ...
  ]
}
</code></pre>
<h4 id="get-the-package-git-changelog"><a class="header" href="#get-the-package-git-changelog">Get the package git changelog</a></h4>
<p>Get git diff between two commits or tags. <strong>WARNING</strong> Working only if repository was cloned by git. 
If you want to use this feature for GitHub you need set composer config flag no-api see here</p>
<pre><code>GET https://example.com/packages/{name}/changelog?token=&lt;api_token&gt;&amp;from=3.1.14&amp;to=3.1.15

{
  &quot;result&quot;: [
    &quot;BAP-18660: ElasticSearch 6&quot;,
    &quot;BB-17293: Back-office &gt;Wrong height&quot;
  ],
  &quot;error&quot;: null,
  &quot;metadata&quot;: {
    &quot;from&quot;: &quot;3.1.14&quot;,
    &quot;to&quot;: &quot;3.1.15&quot;,
    &quot;package&quot;: &quot;okvpn/platform&quot;
  }
}
</code></pre>
<h4 id="getting-package-data"><a class="header" href="#getting-package-data">Getting package data</a></h4>
<p>This is the preferred way to access the data as it is always up-to-date, and dumped to static files so it is very efficient on our end.</p>
<p>You can also send If-Modified-Since headers to limit your bandwidth usage 
and cache the files on your end with the proper filemtime set according to our Last-Modified header.</p>
<p>There are a few gotchas though with using this method:</p>
<ul>
<li>It only provides you with the package metadata but not information about the maintainers, download stats or github info.</li>
<li>It contains providers information which must be ignored but can appear confusing at first. This will disappear in the future though.</li>
</ul>
<pre><code>GET https://example.com/p/[vendor]/[package].json?token=&lt;api_token&gt;

{
  &quot;packages&quot;: {
    &quot;[vendor]/[package]&quot;: {
      &quot;[version1]&quot;: {
        &quot;name&quot;: &quot;[vendor]/[package],
        &quot;description&quot;: [description],
        // ...
      },
      &quot;[version2]&quot;: {
        // ...
      }
      // ...
    }
  }
}
</code></pre>
<p><strong>Composer v2</strong> </p>
<pre><code>GET https://example.com/p2/firebase/php-jwt.json


{
  &quot;minified&quot;: &quot;composer/2.0&quot;,
  &quot;packages&quot;: {
    &quot;[vendor]/[package]&quot;: [... list versions ]
  }
}
</code></pre>
<p><strong>Using the API</strong></p>
<p>The JSON API for packages gives you all the infos we have including downloads, 
dependents count, github info, etc. However, it is generated dynamically so for performance reason we cache the responses 
for twelve hours. As such if the static file endpoint described above is enough please use it instead.</p>
<pre><code>GET https://example.com/packages/[vendor]/[package].json?token=&lt;api_token&gt;

{
  &quot;package&quot;: {
    &quot;name&quot;: &quot;[vendor]/[package],
    &quot;description&quot;: [description],
    &quot;time&quot;: [time of the last release],
    &quot;maintainers&quot;: [list of maintainers],
    &quot;versions&quot;: [list of versions and their dependencies, the same data of composer.json]
    &quot;type&quot;: [package type],
    &quot;repository&quot;: [repository url],
    &quot;downloads&quot;: {
      &quot;total&quot;: [numbers of download],
      &quot;monthly&quot;: [numbers of download per month],
      &quot;daily&quot;: [numbers of download per day]
    },
    &quot;favers&quot;: [number of favers]
  }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generic-packeton-webhooks"><a class="header" href="#generic-packeton-webhooks">Generic Packeton webhooks</a></h1>
<h2 id="introduction-1"><a class="header" href="#introduction-1">Introduction</a></h2>
<p>Webhooks allow external services to be notified when certain events happen. 
When the specified events happen, packeton will send a POST request to each of the URLs you provide.
Now is supported the next events:</p>
<ul>
<li>new_release</li>
<li>update_release</li>
<li>delete_release</li>
<li>push_new_event</li>
<li>update_new_event</li>
<li>http_request</li>
<li>update_repo_failed</li>
<li>new_repo</li>
<li>delete_repo</li>
</ul>
<p><img src="img/diagram.png" alt="diagram" /></p>
<p>It may be useful for release/deploy process, for example: Automatically create new Jira release 
when a new version is created in packagist (triggered when new tag is created in bitbucket) and 
update &quot;fix version&quot; attribute of all the related issues from that release.</p>
<p>To build a custom request payload uses Twig expression language.
This allows you to create custom queries. Untrusted template code is evaluate in a Twig sandbox mode, so 
you will get an error if try to get access for security sensitive information.
By default, only admin users can use Webhooks.</p>
<pre><code>Exception (Twig\Sandbox\SecurityNotAllowedMethodError). Calling &quot;setemail&quot; method on a &quot;Packagist\WebBundle\Entity\User&quot; object is not allowed in &quot;__string_template__0d2344b042278505e67568413272d80429f07ecccea43af39cb33608fa747830&quot; at line 1.
</code></pre>
<h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<ul>
<li><a href="webhook.html#twig-variables">List of twig variables</a></li>
<li><a href="webhook.html#telegram-notification">Telegram notification</a></li>
<li><a href="webhook.html#slack-notification">Slack notification</a></li>
<li><a href="webhook.html#use-url-placeholder">How to use url placeholder</a></li>
<li><a href="webhook.html#interrupt-request">Interrupt request</a></li>
<li><a href="webhook.html#nesting-webhook">Nesting webhook</a></li>
<li><a href="webhook.html#gitlab-auto-webhook">Gitlab setup auto webhook</a></li>
<li><a href="webhook.html#jira-create-a-new-release-and-set-fix-version">JIRA issue fix version</a></li>
<li><a href="webhook.html#external-request">Accept external request</a></li>
<li><a href="webhook.html#new-twig-functions">Packeton twig function</a></li>
</ul>
<h2 id="twig-variables"><a class="header" href="#twig-variables">Twig variables</a></h2>
<ul>
<li>package - <code>Package</code> entity. </li>
<li>versions - <code>Versions[]</code> array of versions.</li>
<li>webhook - <code>Webhook</code> current webhook entity.</li>
<li>user    - <code>User</code> entity. Only for user login event.</li>
<li>parentResponse - <code>HookResponse</code> object. Only for nesting webhook.</li>
<li>request - <code>array</code> Only for http request event.</li>
</ul>
<h2 id="telegram-notification"><a class="header" href="#telegram-notification">Telegram notification</a></h2>
<p>POST <code>https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set text = &quot;*New Releases*\n&quot; %}
{% set title = package.name ~ ' (' ~ versions|map(v =&gt; &quot;#{v.version}&quot;)|join(',') ~ ')' %}
{% set text = text ~ &quot;[&quot; ~ title ~ &quot;](https://pkg.okvpn.org/packages/&quot; ~ package.name ~ &quot;)\n&quot; %}
{% set text = text ~ package.description  %}

{% set request = {
    'chat_id': '-1000006111000',
    'parse_mode': 'Markdown',
    'text': text
} %}

{{ request|json_encode }}
</code></pre>
<p><img src="img/telegram.png" alt="Telegram" /></p>
<h2 id="slack-notification"><a class="header" href="#slack-notification">Slack notification</a></h2>
<p>In first you need create a <a href="https://api.slack.com/apps">slack app</a></p>
<p>POST <code>https://slack.com/api/chat.postMessage</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;,
        &quot;Authorization&quot;: &quot;Bearer xoxp-xxxxxxxxxxxxxxxxxxxxxxxxxx&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set text = &quot;*New Releases*\n&quot; %}
{% set title = package.name ~ ' (' ~ versions|map(v =&gt; &quot;#{v.version}&quot;)|join(',') ~ ')' %}
{% set text = text ~ &quot;&lt;https://pkg.okvpn.org/packages/&quot; ~ package.name ~ &quot;|&quot; ~ title ~ &quot;&gt;\n&quot; %}
{% set text = text ~ package.description  %}

{% set request = {
    'channel': 'jenkins',
    'text': text
} %}

{{ request|json_encode }}
</code></pre>
<h2 id="use-url-placeholder"><a class="header" href="#use-url-placeholder">Use url placeholder</a></h2>
<p>The placeholder allow to build URL parameters from twig template.</p>
<p><code>http://httpbin.org/{{ method }}?repo={{ repoName }}</code></p>
<p><em>Syntax</em></p>
<p>Use <code>placeholder</code> tag </p>
<pre><code>URL: http://httpbin.org/post?repo={{ paramName }}

Variant 1. Send single request.

{% placeholder &lt;paramName&gt; with &lt;string&gt; %}

Variant 2. Send many request for each value from array string[]

{% placeholder &lt;paramName&gt; with &lt;string[]&gt; %}
</code></pre>
<p>Example</p>
<p><code>http://httpbin.org/{{ method }}?repo={{ repoName }}</code></p>
<p>Payload</p>
<pre><code class="language-twig">{% placeholder method with 'post' %}
{% placeholder repoName with [package.name, 'test/test'] %}
</code></pre>
<p><img src="img/placeholder.png" alt="URL Placeholder" /></p>
<h2 id="interrupt-request"><a class="header" href="#interrupt-request">Interrupt request</a></h2>
<p>You can interrupt request if condition is not pass</p>
<p><em>Syntax</em></p>
<p>Use <code>interrupt</code> function.</p>
<p>Payload</p>
<pre><code class="language-twig">{% set request = {
    'chat_id': '1555151',
    'parse_mode': 'Markdown',
    'text': 'Text'
} %}

{% if package.name == 'okvpn/mq-insight' %}
    {{ interrupt() }}
{% endif %}

{{ request|json_encode }}
</code></pre>
<h2 id="nesting-webhook"><a class="header" href="#nesting-webhook">Nesting webhook</a></h2>
<p>You can trigger webhook from twig code. It may be used for send two requests a one event.</p>
<p><em>Syntax</em></p>
<p>Use <code>trigger_webhook(hookId: int|Webhook, context: array)</code> function.</p>
<p>Example Payload</p>
<pre><code class="language-twig">{% do trigger_webhook(6, {'project': 'OK', 'version': versions[0].version}) %}
</code></pre>
<h2 id="jira-create-a-new-release-and-set-fix-version"><a class="header" href="#jira-create-a-new-release-and-set-fix-version">Jira create a new release and set fix version</a></h2>
<p>You need to create two webhook for its, the first must triggers on a new release event, 
the second will be called from twig code.</p>
<p><img src="img/jira.png" alt="Jira" /></p>
<h4 id="create-a-new-release-in-jira"><a class="header" href="#create-a-new-release-in-jira">Create a new release in JIRA</a></h4>
<p>POST <code>https://jiraserver/rest/api/2/version</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    },
    &quot;auth_basic&quot;: &quot;jirauser:password&quot;
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set changeLog = get_changelog(package, null, versions[0].version) %}
{% set ticket = preg_match_all('/((OK|OTEK)-(\\d+))\\s*:/u', changeLog|join(';'), 1) %}

{% set request = {
    'archived': false,
    'releaseDate': versions[0].releasedAt|date('Y-m-d'),
    'name': versions[0].version,
    'released': true,
    'description': 'Packagist auto release',
    'project': 'OK'
} %}

{% if ticket|length == 0 %}
    {{ interrupt('There are not commits with JIRA tiket no.') }}
{% endif %}

{% do trigger_webhook(6, {'project': 'OK', 'ticket': ticket, 'version': versions[0].version}) %}
{{ request|json_encode }}
</code></pre>
<h4 id="update-an-issue-fix-version"><a class="header" href="#update-an-issue-fix-version">Update an issue fix version</a></h4>
<p>PUT <code>https://jiraserver/rest/api/2/issue/{{ issue }}</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    },
    &quot;auth_basic&quot;: &quot;jirauser:password&quot;
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% placeholder issue with ticket %}

{% set request = {
    'fields': {
        'fixVersions': [{'name': version}]
    }
} %}

{{ request|json_encode }}
</code></pre>
<p><img src="img/jira_response.png" alt="Jira issue" /></p>
<h2 id="http-request-from-code"><a class="header" href="#http-request-from-code">Http request from code</a></h2>
<p>You can made http request from twig code.</p>
<pre><code class="language-twig">{% set tags = http_request('https://registry.hub.docker.com/v1/repositories/okvpn/orocommerce/tags') %}

{{ tags|json_encode }}
</code></pre>
<h2 id="external-request"><a class="header" href="#external-request">External request</a></h2>
<p>Triggered webhook by HTTP requests to <code>https://PACKEGIST_URL/api/webhook-invoke/{name}</code></p>
<p>Optional <code>name</code>. If it is specified then this webhook can only be triggered if that name is supplied 
when invoking <code>https://PACKEGIST_URL/api/webhook-invoke/{name}</code> and name restriction is match.</p>
<p>Example payload:</p>
<pre><code class="language-twig">{% if request.packageName is null %}
    {{ interrupt('package name is not found') }}
{% endif %}

{% set tags = http_request('https://registry.hub.docker.com/v1/repositories/' ~ request.packageName ~'/tags') %}

{{ tags|json_encode }}
</code></pre>
<h2 id="gitlab-auto-webhook"><a class="header" href="#gitlab-auto-webhook">Gitlab auto webhook</a></h2>
<p>You can use the event <code>new_repo</code> to add a hook to the specified Gitlab project.
It can be useful, if you don't have a Gold Gitlab Plan that allows configure webhooks for your group,
so you need add it manually for each a new repository.</p>
<p>POST <code>https://{{ host }}/api/v4/projects/{{ repo }}/hooks?private_token=xxxxxxxxxxxxxxxx</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set regex = '#^(?:ssh://git@|https?://|git://|git@)?(?P&lt;host&gt;[a-z0-9.-]+)(?::[0-9]+/|[:/])(?P&lt;path&gt;[\\w.-]+(?:/[\\w.-]+?)+)(?:\\.git|/)?$#i' %}
{% set repository = preg_match_all(regex, package.repository) %}

{% if repository.path[0] is null or repository.host[0] is null %}
    {{ interrupt('Regex is not match') }}
{% endif %}

{% set request = {
    'url': 'https://pkg.okvpn.org/api/update-package?token=admin:xxxxxxxxxxxxxxxx',
    'push_events': true,
    'tag_push_events': true
} %}

{% placeholder host with repository.host[0] %}
{% placeholder repo with repository.path[0]|url_encode %}

{{ request|json_encode }}
</code></pre>
<p>Here you need replace <code>request.url</code> on your packagist. </p>
<h2 id="new-twig-functions"><a class="header" href="#new-twig-functions">New twig functions</a></h2>
<p>See <a href="/src/Webhook/Twig/WebhookExtension.php">WebhookExtension</a> for details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generic-packeton-webhooks-1"><a class="header" href="#generic-packeton-webhooks-1">Generic Packeton webhooks</a></h1>
<h2 id="introduction-2"><a class="header" href="#introduction-2">Introduction</a></h2>
<p>Webhooks allow external services to be notified when certain events happen. 
When the specified events happen, packeton will send a POST request to each of the URLs you provide.
Now is supported the next events:</p>
<ul>
<li>new_release</li>
<li>update_release</li>
<li>delete_release</li>
<li>push_new_event</li>
<li>update_new_event</li>
<li>http_request</li>
<li>update_repo_failed</li>
<li>new_repo</li>
<li>delete_repo</li>
</ul>
<p><img src="img/diagram.png" alt="diagram" /></p>
<p>It may be useful for release/deploy process, for example: Automatically create new Jira release 
when a new version is created in packagist (triggered when new tag is created in bitbucket) and 
update &quot;fix version&quot; attribute of all the related issues from that release.</p>
<p>To build a custom request payload uses Twig expression language.
This allows you to create custom queries. Untrusted template code is evaluate in a Twig sandbox mode, so 
you will get an error if try to get access for security sensitive information.
By default, only admin users can use Webhooks.</p>
<pre><code>Exception (Twig\Sandbox\SecurityNotAllowedMethodError). Calling &quot;setemail&quot; method on a &quot;Packagist\WebBundle\Entity\User&quot; object is not allowed in &quot;__string_template__0d2344b042278505e67568413272d80429f07ecccea43af39cb33608fa747830&quot; at line 1.
</code></pre>
<h1 id="examples-1"><a class="header" href="#examples-1">Examples</a></h1>
<ul>
<li><a href="webhook.html#twig-variables">List of twig variables</a></li>
<li><a href="webhook.html#telegram-notification">Telegram notification</a></li>
<li><a href="webhook.html#slack-notification">Slack notification</a></li>
<li><a href="webhook.html#use-url-placeholder">How to use url placeholder</a></li>
<li><a href="webhook.html#interrupt-request">Interrupt request</a></li>
<li><a href="webhook.html#nesting-webhook">Nesting webhook</a></li>
<li><a href="webhook.html#gitlab-auto-webhook">Gitlab setup auto webhook</a></li>
<li><a href="webhook.html#jira-create-a-new-release-and-set-fix-version">JIRA issue fix version</a></li>
<li><a href="webhook.html#external-request">Accept external request</a></li>
<li><a href="webhook.html#new-twig-functions">Packeton twig function</a></li>
</ul>
<h2 id="twig-variables-1"><a class="header" href="#twig-variables-1">Twig variables</a></h2>
<ul>
<li>package - <code>Package</code> entity. </li>
<li>versions - <code>Versions[]</code> array of versions.</li>
<li>webhook - <code>Webhook</code> current webhook entity.</li>
<li>user    - <code>User</code> entity. Only for user login event.</li>
<li>parentResponse - <code>HookResponse</code> object. Only for nesting webhook.</li>
<li>request - <code>array</code> Only for http request event.</li>
</ul>
<h2 id="telegram-notification-1"><a class="header" href="#telegram-notification-1">Telegram notification</a></h2>
<p>POST <code>https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set text = &quot;*New Releases*\n&quot; %}
{% set title = package.name ~ ' (' ~ versions|map(v =&gt; &quot;#{v.version}&quot;)|join(',') ~ ')' %}
{% set text = text ~ &quot;[&quot; ~ title ~ &quot;](https://pkg.okvpn.org/packages/&quot; ~ package.name ~ &quot;)\n&quot; %}
{% set text = text ~ package.description  %}

{% set request = {
    'chat_id': '-1000006111000',
    'parse_mode': 'Markdown',
    'text': text
} %}

{{ request|json_encode }}
</code></pre>
<p><img src="img/telegram.png" alt="Telegram" /></p>
<h2 id="slack-notification-1"><a class="header" href="#slack-notification-1">Slack notification</a></h2>
<p>In first you need create a <a href="https://api.slack.com/apps">slack app</a></p>
<p>POST <code>https://slack.com/api/chat.postMessage</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;,
        &quot;Authorization&quot;: &quot;Bearer xoxp-xxxxxxxxxxxxxxxxxxxxxxxxxx&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set text = &quot;*New Releases*\n&quot; %}
{% set title = package.name ~ ' (' ~ versions|map(v =&gt; &quot;#{v.version}&quot;)|join(',') ~ ')' %}
{% set text = text ~ &quot;&lt;https://pkg.okvpn.org/packages/&quot; ~ package.name ~ &quot;|&quot; ~ title ~ &quot;&gt;\n&quot; %}
{% set text = text ~ package.description  %}

{% set request = {
    'channel': 'jenkins',
    'text': text
} %}

{{ request|json_encode }}
</code></pre>
<h2 id="use-url-placeholder-1"><a class="header" href="#use-url-placeholder-1">Use url placeholder</a></h2>
<p>The placeholder allow to build URL parameters from twig template.</p>
<p><code>http://httpbin.org/{{ method }}?repo={{ repoName }}</code></p>
<p><em>Syntax</em></p>
<p>Use <code>placeholder</code> tag </p>
<pre><code>URL: http://httpbin.org/post?repo={{ paramName }}

Variant 1. Send single request.

{% placeholder &lt;paramName&gt; with &lt;string&gt; %}

Variant 2. Send many request for each value from array string[]

{% placeholder &lt;paramName&gt; with &lt;string[]&gt; %}
</code></pre>
<p>Example</p>
<p><code>http://httpbin.org/{{ method }}?repo={{ repoName }}</code></p>
<p>Payload</p>
<pre><code class="language-twig">{% placeholder method with 'post' %}
{% placeholder repoName with [package.name, 'test/test'] %}
</code></pre>
<p><img src="img/placeholder.png" alt="URL Placeholder" /></p>
<h2 id="interrupt-request-1"><a class="header" href="#interrupt-request-1">Interrupt request</a></h2>
<p>You can interrupt request if condition is not pass</p>
<p><em>Syntax</em></p>
<p>Use <code>interrupt</code> function.</p>
<p>Payload</p>
<pre><code class="language-twig">{% set request = {
    'chat_id': '1555151',
    'parse_mode': 'Markdown',
    'text': 'Text'
} %}

{% if package.name == 'okvpn/mq-insight' %}
    {{ interrupt() }}
{% endif %}

{{ request|json_encode }}
</code></pre>
<h2 id="nesting-webhook-1"><a class="header" href="#nesting-webhook-1">Nesting webhook</a></h2>
<p>You can trigger webhook from twig code. It may be used for send two requests a one event.</p>
<p><em>Syntax</em></p>
<p>Use <code>trigger_webhook(hookId: int|Webhook, context: array)</code> function.</p>
<p>Example Payload</p>
<pre><code class="language-twig">{% do trigger_webhook(6, {'project': 'OK', 'version': versions[0].version}) %}
</code></pre>
<h2 id="jira-create-a-new-release-and-set-fix-version-1"><a class="header" href="#jira-create-a-new-release-and-set-fix-version-1">Jira create a new release and set fix version</a></h2>
<p>You need to create two webhook for its, the first must triggers on a new release event, 
the second will be called from twig code.</p>
<p><img src="img/jira.png" alt="Jira" /></p>
<h4 id="create-a-new-release-in-jira-1"><a class="header" href="#create-a-new-release-in-jira-1">Create a new release in JIRA</a></h4>
<p>POST <code>https://jiraserver/rest/api/2/version</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    },
    &quot;auth_basic&quot;: &quot;jirauser:password&quot;
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set changeLog = get_changelog(package, null, versions[0].version) %}
{% set ticket = preg_match_all('/((OK|OTEK)-(\\d+))\\s*:/u', changeLog|join(';'), 1) %}

{% set request = {
    'archived': false,
    'releaseDate': versions[0].releasedAt|date('Y-m-d'),
    'name': versions[0].version,
    'released': true,
    'description': 'Packagist auto release',
    'project': 'OK'
} %}

{% if ticket|length == 0 %}
    {{ interrupt('There are not commits with JIRA tiket no.') }}
{% endif %}

{% do trigger_webhook(6, {'project': 'OK', 'ticket': ticket, 'version': versions[0].version}) %}
{{ request|json_encode }}
</code></pre>
<h4 id="update-an-issue-fix-version-1"><a class="header" href="#update-an-issue-fix-version-1">Update an issue fix version</a></h4>
<p>PUT <code>https://jiraserver/rest/api/2/issue/{{ issue }}</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    },
    &quot;auth_basic&quot;: &quot;jirauser:password&quot;
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% placeholder issue with ticket %}

{% set request = {
    'fields': {
        'fixVersions': [{'name': version}]
    }
} %}

{{ request|json_encode }}
</code></pre>
<p><img src="img/jira_response.png" alt="Jira issue" /></p>
<h2 id="http-request-from-code-1"><a class="header" href="#http-request-from-code-1">Http request from code</a></h2>
<p>You can made http request from twig code.</p>
<pre><code class="language-twig">{% set tags = http_request('https://registry.hub.docker.com/v1/repositories/okvpn/orocommerce/tags') %}

{{ tags|json_encode }}
</code></pre>
<h2 id="external-request-1"><a class="header" href="#external-request-1">External request</a></h2>
<p>Triggered webhook by HTTP requests to <code>https://PACKEGIST_URL/api/webhook-invoke/{name}</code></p>
<p>Optional <code>name</code>. If it is specified then this webhook can only be triggered if that name is supplied 
when invoking <code>https://PACKEGIST_URL/api/webhook-invoke/{name}</code> and name restriction is match.</p>
<p>Example payload:</p>
<pre><code class="language-twig">{% if request.packageName is null %}
    {{ interrupt('package name is not found') }}
{% endif %}

{% set tags = http_request('https://registry.hub.docker.com/v1/repositories/' ~ request.packageName ~'/tags') %}

{{ tags|json_encode }}
</code></pre>
<h2 id="gitlab-auto-webhook-1"><a class="header" href="#gitlab-auto-webhook-1">Gitlab auto webhook</a></h2>
<p>You can use the event <code>new_repo</code> to add a hook to the specified Gitlab project.
It can be useful, if you don't have a Gold Gitlab Plan that allows configure webhooks for your group,
so you need add it manually for each a new repository.</p>
<p>POST <code>https://{{ host }}/api/v4/projects/{{ repo }}/hooks?private_token=xxxxxxxxxxxxxxxx</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set regex = '#^(?:ssh://git@|https?://|git://|git@)?(?P&lt;host&gt;[a-z0-9.-]+)(?::[0-9]+/|[:/])(?P&lt;path&gt;[\\w.-]+(?:/[\\w.-]+?)+)(?:\\.git|/)?$#i' %}
{% set repository = preg_match_all(regex, package.repository) %}

{% if repository.path[0] is null or repository.host[0] is null %}
    {{ interrupt('Regex is not match') }}
{% endif %}

{% set request = {
    'url': 'https://pkg.okvpn.org/api/update-package?token=admin:xxxxxxxxxxxxxxxx',
    'push_events': true,
    'tag_push_events': true
} %}

{% placeholder host with repository.host[0] %}
{% placeholder repo with repository.path[0]|url_encode %}

{{ request|json_encode }}
</code></pre>
<p>Here you need replace <code>request.url</code> on your packagist. </p>
<h2 id="new-twig-functions-1"><a class="header" href="#new-twig-functions-1">New twig functions</a></h2>
<p>See <a href="/src/Webhook/Twig/WebhookExtension.php">WebhookExtension</a> for details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generic-packeton-webhooks-2"><a class="header" href="#generic-packeton-webhooks-2">Generic Packeton webhooks</a></h1>
<h2 id="introduction-3"><a class="header" href="#introduction-3">Introduction</a></h2>
<p>Webhooks allow external services to be notified when certain events happen. 
When the specified events happen, packeton will send a POST request to each of the URLs you provide.
Now is supported the next events:</p>
<ul>
<li>new_release</li>
<li>update_release</li>
<li>delete_release</li>
<li>push_new_event</li>
<li>update_new_event</li>
<li>http_request</li>
<li>update_repo_failed</li>
<li>new_repo</li>
<li>delete_repo</li>
</ul>
<p><img src="img/diagram.png" alt="diagram" /></p>
<p>It may be useful for release/deploy process, for example: Automatically create new Jira release 
when a new version is created in packagist (triggered when new tag is created in bitbucket) and 
update &quot;fix version&quot; attribute of all the related issues from that release.</p>
<p>To build a custom request payload uses Twig expression language.
This allows you to create custom queries. Untrusted template code is evaluate in a Twig sandbox mode, so 
you will get an error if try to get access for security sensitive information.
By default, only admin users can use Webhooks.</p>
<pre><code>Exception (Twig\Sandbox\SecurityNotAllowedMethodError). Calling &quot;setemail&quot; method on a &quot;Packagist\WebBundle\Entity\User&quot; object is not allowed in &quot;__string_template__0d2344b042278505e67568413272d80429f07ecccea43af39cb33608fa747830&quot; at line 1.
</code></pre>
<h1 id="examples-2"><a class="header" href="#examples-2">Examples</a></h1>
<ul>
<li><a href="webhook.html#twig-variables">List of twig variables</a></li>
<li><a href="webhook.html#telegram-notification">Telegram notification</a></li>
<li><a href="webhook.html#slack-notification">Slack notification</a></li>
<li><a href="webhook.html#use-url-placeholder">How to use url placeholder</a></li>
<li><a href="webhook.html#interrupt-request">Interrupt request</a></li>
<li><a href="webhook.html#nesting-webhook">Nesting webhook</a></li>
<li><a href="webhook.html#gitlab-auto-webhook">Gitlab setup auto webhook</a></li>
<li><a href="webhook.html#jira-create-a-new-release-and-set-fix-version">JIRA issue fix version</a></li>
<li><a href="webhook.html#external-request">Accept external request</a></li>
<li><a href="webhook.html#new-twig-functions">Packeton twig function</a></li>
</ul>
<h2 id="twig-variables-2"><a class="header" href="#twig-variables-2">Twig variables</a></h2>
<ul>
<li>package - <code>Package</code> entity. </li>
<li>versions - <code>Versions[]</code> array of versions.</li>
<li>webhook - <code>Webhook</code> current webhook entity.</li>
<li>user    - <code>User</code> entity. Only for user login event.</li>
<li>parentResponse - <code>HookResponse</code> object. Only for nesting webhook.</li>
<li>request - <code>array</code> Only for http request event.</li>
</ul>
<h2 id="telegram-notification-2"><a class="header" href="#telegram-notification-2">Telegram notification</a></h2>
<p>POST <code>https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set text = &quot;*New Releases*\n&quot; %}
{% set title = package.name ~ ' (' ~ versions|map(v =&gt; &quot;#{v.version}&quot;)|join(',') ~ ')' %}
{% set text = text ~ &quot;[&quot; ~ title ~ &quot;](https://pkg.okvpn.org/packages/&quot; ~ package.name ~ &quot;)\n&quot; %}
{% set text = text ~ package.description  %}

{% set request = {
    'chat_id': '-1000006111000',
    'parse_mode': 'Markdown',
    'text': text
} %}

{{ request|json_encode }}
</code></pre>
<p><img src="img/telegram.png" alt="Telegram" /></p>
<h2 id="slack-notification-2"><a class="header" href="#slack-notification-2">Slack notification</a></h2>
<p>In first you need create a <a href="https://api.slack.com/apps">slack app</a></p>
<p>POST <code>https://slack.com/api/chat.postMessage</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;,
        &quot;Authorization&quot;: &quot;Bearer xoxp-xxxxxxxxxxxxxxxxxxxxxxxxxx&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set text = &quot;*New Releases*\n&quot; %}
{% set title = package.name ~ ' (' ~ versions|map(v =&gt; &quot;#{v.version}&quot;)|join(',') ~ ')' %}
{% set text = text ~ &quot;&lt;https://pkg.okvpn.org/packages/&quot; ~ package.name ~ &quot;|&quot; ~ title ~ &quot;&gt;\n&quot; %}
{% set text = text ~ package.description  %}

{% set request = {
    'channel': 'jenkins',
    'text': text
} %}

{{ request|json_encode }}
</code></pre>
<h2 id="use-url-placeholder-2"><a class="header" href="#use-url-placeholder-2">Use url placeholder</a></h2>
<p>The placeholder allow to build URL parameters from twig template.</p>
<p><code>http://httpbin.org/{{ method }}?repo={{ repoName }}</code></p>
<p><em>Syntax</em></p>
<p>Use <code>placeholder</code> tag </p>
<pre><code>URL: http://httpbin.org/post?repo={{ paramName }}

Variant 1. Send single request.

{% placeholder &lt;paramName&gt; with &lt;string&gt; %}

Variant 2. Send many request for each value from array string[]

{% placeholder &lt;paramName&gt; with &lt;string[]&gt; %}
</code></pre>
<p>Example</p>
<p><code>http://httpbin.org/{{ method }}?repo={{ repoName }}</code></p>
<p>Payload</p>
<pre><code class="language-twig">{% placeholder method with 'post' %}
{% placeholder repoName with [package.name, 'test/test'] %}
</code></pre>
<p><img src="img/placeholder.png" alt="URL Placeholder" /></p>
<h2 id="interrupt-request-2"><a class="header" href="#interrupt-request-2">Interrupt request</a></h2>
<p>You can interrupt request if condition is not pass</p>
<p><em>Syntax</em></p>
<p>Use <code>interrupt</code> function.</p>
<p>Payload</p>
<pre><code class="language-twig">{% set request = {
    'chat_id': '1555151',
    'parse_mode': 'Markdown',
    'text': 'Text'
} %}

{% if package.name == 'okvpn/mq-insight' %}
    {{ interrupt() }}
{% endif %}

{{ request|json_encode }}
</code></pre>
<h2 id="nesting-webhook-2"><a class="header" href="#nesting-webhook-2">Nesting webhook</a></h2>
<p>You can trigger webhook from twig code. It may be used for send two requests a one event.</p>
<p><em>Syntax</em></p>
<p>Use <code>trigger_webhook(hookId: int|Webhook, context: array)</code> function.</p>
<p>Example Payload</p>
<pre><code class="language-twig">{% do trigger_webhook(6, {'project': 'OK', 'version': versions[0].version}) %}
</code></pre>
<h2 id="jira-create-a-new-release-and-set-fix-version-2"><a class="header" href="#jira-create-a-new-release-and-set-fix-version-2">Jira create a new release and set fix version</a></h2>
<p>You need to create two webhook for its, the first must triggers on a new release event, 
the second will be called from twig code.</p>
<p><img src="img/jira.png" alt="Jira" /></p>
<h4 id="create-a-new-release-in-jira-2"><a class="header" href="#create-a-new-release-in-jira-2">Create a new release in JIRA</a></h4>
<p>POST <code>https://jiraserver/rest/api/2/version</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    },
    &quot;auth_basic&quot;: &quot;jirauser:password&quot;
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set changeLog = get_changelog(package, null, versions[0].version) %}
{% set ticket = preg_match_all('/((OK|OTEK)-(\\d+))\\s*:/u', changeLog|join(';'), 1) %}

{% set request = {
    'archived': false,
    'releaseDate': versions[0].releasedAt|date('Y-m-d'),
    'name': versions[0].version,
    'released': true,
    'description': 'Packagist auto release',
    'project': 'OK'
} %}

{% if ticket|length == 0 %}
    {{ interrupt('There are not commits with JIRA tiket no.') }}
{% endif %}

{% do trigger_webhook(6, {'project': 'OK', 'ticket': ticket, 'version': versions[0].version}) %}
{{ request|json_encode }}
</code></pre>
<h4 id="update-an-issue-fix-version-2"><a class="header" href="#update-an-issue-fix-version-2">Update an issue fix version</a></h4>
<p>PUT <code>https://jiraserver/rest/api/2/issue/{{ issue }}</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    },
    &quot;auth_basic&quot;: &quot;jirauser:password&quot;
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% placeholder issue with ticket %}

{% set request = {
    'fields': {
        'fixVersions': [{'name': version}]
    }
} %}

{{ request|json_encode }}
</code></pre>
<p><img src="img/jira_response.png" alt="Jira issue" /></p>
<h2 id="http-request-from-code-2"><a class="header" href="#http-request-from-code-2">Http request from code</a></h2>
<p>You can made http request from twig code.</p>
<pre><code class="language-twig">{% set tags = http_request('https://registry.hub.docker.com/v1/repositories/okvpn/orocommerce/tags') %}

{{ tags|json_encode }}
</code></pre>
<h2 id="external-request-2"><a class="header" href="#external-request-2">External request</a></h2>
<p>Triggered webhook by HTTP requests to <code>https://PACKEGIST_URL/api/webhook-invoke/{name}</code></p>
<p>Optional <code>name</code>. If it is specified then this webhook can only be triggered if that name is supplied 
when invoking <code>https://PACKEGIST_URL/api/webhook-invoke/{name}</code> and name restriction is match.</p>
<p>Example payload:</p>
<pre><code class="language-twig">{% if request.packageName is null %}
    {{ interrupt('package name is not found') }}
{% endif %}

{% set tags = http_request('https://registry.hub.docker.com/v1/repositories/' ~ request.packageName ~'/tags') %}

{{ tags|json_encode }}
</code></pre>
<h2 id="gitlab-auto-webhook-2"><a class="header" href="#gitlab-auto-webhook-2">Gitlab auto webhook</a></h2>
<p>You can use the event <code>new_repo</code> to add a hook to the specified Gitlab project.
It can be useful, if you don't have a Gold Gitlab Plan that allows configure webhooks for your group,
so you need add it manually for each a new repository.</p>
<p>POST <code>https://{{ host }}/api/v4/projects/{{ repo }}/hooks?private_token=xxxxxxxxxxxxxxxx</code></p>
<p>Options:</p>
<pre><code class="language-json">{
    &quot;headers&quot;: {
        &quot;Content-Type&quot;: &quot;application/json&quot;
    }
}
</code></pre>
<p>Payload</p>
<pre><code class="language-twig">{% set regex = '#^(?:ssh://git@|https?://|git://|git@)?(?P&lt;host&gt;[a-z0-9.-]+)(?::[0-9]+/|[:/])(?P&lt;path&gt;[\\w.-]+(?:/[\\w.-]+?)+)(?:\\.git|/)?$#i' %}
{% set repository = preg_match_all(regex, package.repository) %}

{% if repository.path[0] is null or repository.host[0] is null %}
    {{ interrupt('Regex is not match') }}
{% endif %}

{% set request = {
    'url': 'https://pkg.okvpn.org/api/update-package?token=admin:xxxxxxxxxxxxxxxx',
    'push_events': true,
    'tag_push_events': true
} %}

{% placeholder host with repository.host[0] %}
{% placeholder repo with repository.path[0]|url_encode %}

{{ request|json_encode }}
</code></pre>
<p>Here you need replace <code>request.url</code> on your packagist. </p>
<h2 id="new-twig-functions-2"><a class="header" href="#new-twig-functions-2">New twig functions</a></h2>
<p>See <a href="/src/Webhook/Twig/WebhookExtension.php">WebhookExtension</a> for details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manage-secrets"><a class="header" href="#manage-secrets">Manage secrets</a></h1>
<p>Before adding sensitive data such as API credentials to your webhook payload strongly 
recommended to encrypt it. Secret data will not be save to database or shows on webhooks' status. 
Alternative way you can set own visibility for webhook entity to prevent edit by other admin users.</p>
<h3 id="encrypt-secrets"><a class="header" href="#encrypt-secrets">Encrypt secrets</a></h3>
<p>To add secrets to your webhook, put JSON body to <code>Request options</code> field, for example</p>
<pre><code class="language-json">{
//     &quot;headers&quot;  more other options 
    &quot;secrets&quot;: {
        &quot;allowed-domains&quot;: [&quot;api.telegram.org&quot;],
        &quot;TOKEN&quot;: &quot;167000000:AAzddkPzfgzkqzzFghiwPutin_khuylo&quot;,
        &quot;CHART_ID&quot;: &quot;-1000017160005&quot;
    }
}
</code></pre>
<p><a href="webhook/../img/secrets.png"><img src="webhook/../img/secrets.png" alt="secrets" /></a></p>
<p>Once the form is submitted, the secret params will be encrypted and sign and cannot be changed.
The sign algo is hmac sha256 with <code>APP_SECRET</code> as key. Digital signature required to prevent modification
encrypted data and attack on change <code>allowed-domains</code> </p>
<h4 id="secrets-option"><a class="header" href="#secrets-option">Secrets option</a></h4>
<p><code>allowed-domains</code> - you can restrict webhook call to untrusted hosts to prevent modify the change URL parameter.</p>
<h3 id="usage-secrets"><a class="header" href="#usage-secrets">Usage secrets</a></h3>
<p>Use secrets params in request, url or headers options, example:</p>
<pre><code>https://api.telegram.org/bot${secrets.TOKEN}/sendMessage
</code></pre>
<p>In body</p>
<pre><code class="language-twig">{% set request = {
    'chat_id': '${secrets.CHART_ID}',
    'text': 'example text'
} %}
{{ request|json_encode }}
</code></pre>
<p>But this example will not work.</p>
<pre><code class="language-twig">{% set request = {
    'chat_id': '${secrets.CHART_ID}',
    'text': 'example text'
} %}
{% do log('${secrets.CHART_ID}')

{{ request|json_encode }}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="webhook-security"><a class="header" href="#webhook-security">Webhook security</a></h1>
<p>To evaluate expressions uses a Twig sandbox mode.</p>
<p>You will get an error if try to get access for security sensitive information.</p>
<p><strong>SSRF</strong> - To prevent SSRF attacks to make HTTP requests to inner private networks uses <code>NoPrivateNetworkHttpClient</code>,
so not possible call url like <code>http://10.8.100.1/</code> etc.</p>
<pre><code># This code is not works.

{% set text = &quot;*New Releases*\n&quot; %}
{% set title = package.name ~ ' (' ~ versions|map(v =&gt; &quot;#{v.version}&quot;)|join(',') ~ ')' %}

{% set text = text ~ package.credentials.key  %}

{% set request = {
    'channel': 'jenkins',
    'text': text
} %}

{{ request|json_encode }}

</code></pre>
<pre><code>Exception (Twig\Sandbox\SecurityNotAllowedMethodError). Calling &quot;getcredentials&quot; method on a &quot;Packeton\Entity\Package&quot; 
object is not allowed in &quot;__string_template__4b1d9dd7416b75a6c353bd4750fe5490&quot; at line 4.
</code></pre>
<p>Block SSRF</p>
<pre><code>Exception (Symfony\Component\HttpClient\Exception\TransportException). IP &quot;127.0.0.1&quot; is blocked for &quot;https://pack.loc.example.org/webhooks&quot;.
 * Prev exception (Symfony\Component\HttpClient\Exception\TransportException). IP &quot;127.0.0.1&quot; is blocked for &quot;https://pack.loc.example.org/webhooks&quot;.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="test-webhook-twig-payload"><a class="header" href="#test-webhook-twig-payload">Test Webhook Twig payload.</a></h1>
<p>You can use test action to check result</p>
<p><a href="webhook/../img/wh-test.png"><img src="webhook/../img/wh-test.png" alt="Test" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-auto-update-packages"><a class="header" href="#how-to-auto-update-packages">How to auto update packages?</a></h1>
<p>You can use GitLab, GitHub, and Bitbucket project post-receive hook to keep your packages up to date every time you push code.</p>
<h2 id="into"><a class="header" href="#into">Into</a></h2>
<p>Webhook API request authorization with minimum access level <code>ROLE_MAINTAINER</code>. 
You can use <code>token</code> query parameter with <code>&lt;username:api_token&gt;</code> to call it. </p>
<p>Also support Packagist.org authorization with <code>username</code> and <code>apiToken</code> query parameters.</p>
<h2 id="bitbucket-webhooks"><a class="header" href="#bitbucket-webhooks">Bitbucket Webhooks</a></h2>
<p>To enable the Bitbucket web hook, go to your BitBucket repository,
open the settings and select &quot;Webhooks&quot; in the menu. Add a new hook. Y
ou have to enter the Packagist endpoint, containing both your username and API token.
Enter <code>https://&lt;app&gt;/api/bitbucket?token=user:token</code> as URL. Save your changes and you're done.</p>
<h2 id="gitlab-service"><a class="header" href="#gitlab-service">GitLab Service</a></h2>
<p>To enable the GitLab service integration, go to your GitLab repository, open
the Settings &gt; Integrations page from the menu.
Search for Packagist in the list of Project Services. Check the &quot;Active&quot; box,
enter your <code>packeton.org</code> username and API token. Save your changes and you're done.</p>
<h2 id="gitlab-group-hooks"><a class="header" href="#gitlab-group-hooks">GitLab Group Hooks</a></h2>
<p>Group webhooks will apply to all projects in a group and allow to sync all projects.
To enable the Group GitLab webhook you must have the paid plan.
Go to your GitLab Group &gt; Settings &gt; Webhooks.
Enter <code>https://&lt;app&gt;/api/update-package?token=user:token</code> as URL.</p>
<h2 id="github-webhooks"><a class="header" href="#github-webhooks">GitHub Webhooks</a></h2>
<p>To enable the GitHub webhook go to your GitHub repository. Click the &quot;Settings&quot; button, click &quot;Webhooks&quot;.
Add a new hook. Enter <code>https://&lt;app&gt;/api/github?token=user:token</code> as URL.</p>
<h2 id="gitea-webhooks"><a class="header" href="#gitea-webhooks">Gitea Webhooks</a></h2>
<p>To enable the Gitea web hook, go to your Gitea repository, open the settings, select &quot;Webhooks&quot; 
in the menu and click on 'Add Webhook'. From the dropdown menu select Gitea.
You have to enter the Packagist endpoint, containing both your username and API token. 
Enter <code>https://&lt;app&gt;/api/update-package?token=user:token</code> as URL. 
The HTTP method has to be POST and content type is application/json. Save your changes and you're done.</p>
<h2 id="manual-hook-setup"><a class="header" href="#manual-hook-setup">Manual hook setup</a></h2>
<p>If you do not use Bitbucket or GitHub there is a generic endpoint you can call manually
from a git post-receive hook or similar. You have to do a POST request to
<code>https://&lt;app&gt;g/api/update-package?token=user:api_token</code> with a request body looking like this:</p>
<pre><code>{
  &quot;repository&quot;: {
    &quot;url&quot;: &quot;PACKAGIST_PACKAGE_URL&quot;
  }
}
</code></pre>
<p>You can also send a GET request with query parameter <code>composer_package_name</code></p>
<pre><code>curl 'https://&lt;app&gt;/api/update-package?token=&lt;user:token&gt;&amp;composer_package_name=vender/name'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="customer-users"><a class="header" href="#customer-users">Customer Users</a></h1>
<p>You can create customers user and manage their packages access.
The customer users have may have two users role:</p>
<ul>
<li><code>ROLE_USER</code> - minimal access level, these users only can read metadata only for selected packages</li>
<li><code>ROLE_FULL_CUSTOMER</code> - Can read all packages metadata without groups ACL restriction.</li>
</ul>
<p>For <code>ROLE_USER</code> you will be able to limit packages access by release date too. </p>
<p>To grant access to your packages, need to create ACL group in the first.</p>
<p><a href="usage/../img/groups.png"><img src="usage/../img/groups.png" alt="Groups" /></a></p>
<h3 id="create-customer-user"><a class="header" href="#create-customer-user">Create Customer User.</a></h3>
<p>After creating an ACL group, you may to create a user and grant access to more that one groups.
If selected more than one group, then all groups permission will be union together. </p>
<p><a href="usage/../img/users.png"><img src="usage/../img/users.png" alt="Users" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ssh-credential-and-composer-auth"><a class="header" href="#ssh-credential-and-composer-auth">SSH Credential and Composer Auth.</a></h1>
<p>Composer provide two why of authentication for privately hosted packages. </p>
<p>You may to setup authentication in <code>auth.json</code> in composer home, i e. <code>/var/www/packeton/var/.composer/</code> 
or <code>/data/composer/auth.json</code> for docker installation. </p>
<p>See example usage <a href="usage/../installation.html#ssh-key-access-and-composer-oauth-token">system auth setup</a></p>
<h3 id="using-ui-credential-manager"><a class="header" href="#using-ui-credential-manager">Using UI Credential Manager</a></h3>
<p>You can overwrite credentials for each repository in UI.</p>
<p>All credentials are encrypted in database by custom DBAL type <code>EncryptedTextType</code>.
Encrypted key is <code>APP_SECRET</code> so it must be permanent.</p>
<p><a href="usage/../img/keys.png"><img src="usage/../img/keys.png" alt="Groups" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mirroring-and-composer-proxies"><a class="header" href="#mirroring-and-composer-proxies">Mirroring and Composer proxies</a></h1>
<p>Packeton can function as a proxy for the Composer repository, including which require authentication.
This feature can be used to grant all developers and clients access to private repositories such as Magento.
Additionally, it is possible to create ZIP archives from mirrored Git repositories of packages, in cases where HTTP dist
is unavailable.</p>
<h2 id="main-features-1"><a class="header" href="#main-features-1">Main Features</a></h2>
<ul>
<li>Supports full and lazy synchronization for small and large Composer repositories.</li>
<li>Supports the Packagist fast <code>metadata-changes-url</code> API.</li>
<li>Includes Strict Mode and Dependencies Approval functionality.</li>
<li>Supports Dist/SSH mirroring of source code.</li>
</ul>
<p>Example metadata with Strict mode and manual dependencies' approval.</p>
<pre><code class="language-json">{
    &quot;includes&quot;: {
        &quot;include-packeton/all$f05f56b8bd12d014a753cdbe6a7d749facd40908.json&quot;: {
            &quot;sha1&quot;: &quot;f05f56b8bd12d014a753cdbe6a7d749facd40908&quot;
        }
    },
    &quot;mirrors&quot;: [
        {
            &quot;dist-url&quot;: &quot;/mirror/orocrm/zipball/%package%/%version%/%reference%.%type%&quot;,
            &quot;preferred&quot;: true
        }
    ],
    &quot;metadata-url&quot;: &quot;/mirror/orocrm/p2/%package%.json&quot;,
    &quot;available-packages&quot;: [
        &quot;romanpitak/dotmailer-api-v2-client&quot;,
        &quot;oro/platform-enterprise&quot;,
        &quot;oro/crm-enterprise&quot;,
        &quot;oro/api-doc-bundle&quot;,
        &quot;oro/flotr2&quot;,
        &quot;oro/crm-pro-ldap-bundle&quot;,
        &quot;oro/multi-host&quot;,
        &quot;akeneo/batch-bundle&quot;
    ]
}
</code></pre>
<p>Original metadata is:</p>
<pre><code class="language-json">{
    &quot;packages&quot;: [],
    &quot;providers-url&quot;: &quot;/p/%package%$%hash%.json&quot;,
    &quot;providers&quot;: {
        &quot;actualys/drupal-commerce-connector-bundle&quot;: {
            &quot;sha256&quot;: &quot;4163f3b470b3b824cbcebee5a0d58ea3d516b7b5fa78617ba21120eeec9e494f&quot;
        },
        &quot;agencednd/oro-api-connector-bundle&quot;: {
            &quot;sha256&quot;: &quot;169c0963fd8442c190f2e9303e0e6fa1fe9ad0c9fb2f6782176d02e65a48eada&quot;
        },
        &quot;akeneo/batch-bundle&quot;: {
            &quot;sha256&quot;: &quot;4f2c1b9a43124524da45b35236acabd3ee1ad329980b885089e9eb408c1bca01&quot;
        },
    ...
    + 57 packages
</code></pre>
<p>For performance if composer user-agent == 1 then <code>includes</code> replaced with <code>providers-lazy-url</code></p>
<p><a href="usage/../img/packeton_proxies.png"><img src="usage/../img/packeton_proxies.png" alt="logo" /></a></p>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<p>Example how to enable proxies in your local configuration.
To enable proxies in your local configuration, create a file with any name
like <code>config/packages/any-name.yaml</code> and add the following configuration:</p>
<pre><code class="language-yaml">packeton:
    mirrors:
        packagist:
            url: https://repo.packagist.org
        orocrm:
            url: https://satis.oroinc.com/
            git_ssh_keys:
                git@github.com:oroinc: '/var/www/.ssh/private_key1'
                git@github.com:org2: '/var/www/.ssh/private_key2'
        example:
            url: https://satis.example.com/
            logo: 'https://example.com/logo.png'
            http_basic:
                username: 123
                password: 123
            public_access: true # Allow public access, default false
            sync_lazy: true # default false 
            enable_dist_mirror: false # default true
            available_package_patterns: # Additional restriction, but you can restrict it in UI
                - 'vend1/*' 
            available_packages:
                - 'pack1/name1' # but you can restrict it in UI
            composer_auth: '{&quot;auth.json...&quot;}' # JSON. auth.json to pass composer opts.
            sync_interval: 3600 # default auto.
            info_cmd_message: &quot;\n\u001b[37;44m#Слава\u001b[30;43mУкраїні!\u001b[0m\n\u001b[40;31m#Смерть\u001b[30;41mворогам\u001b[0m&quot; # Info message
</code></pre>
<p>The configuration allows you to use multiple SSH key settings for different GitHub accounts.</p>
<pre><code>...
git_ssh_keys:
    git@github.com:oroinc: '/var/www/.ssh/private_key1'
    git@github.com:org2: '/var/www/.ssh/private_key2'

# Or one key
git_ssh_keys: '/var/www/.ssh/private_key1'
</code></pre>
<h2 id="metadata-proxy-specification"><a class="header" href="#metadata-proxy-specification">Metadata Proxy Specification.</a></h2>
<p>The specification for the metadata proxy depends on the type of repository and the synchronization strategy being used.</p>
<div class="table-wrapper"><table><thead><tr><th>API</th><th>Full sync</th><th>Lazy sync</th><th>Mirroring (strict)</th></tr></thead><tbody>
<tr><td>V1</td><td>provider-includes (parent)</td><td>providers-lazy-url</td><td>includes</td></tr>
<tr><td>V2</td><td>meta v2 + available-packages (depends on size)</td><td>meta v2</td><td>meta v2 + available-packages</td></tr>
</tbody></table>
</div>
<h3 id="default-sync-intervals"><a class="header" href="#default-sync-intervals">Default sync intervals</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Repo</th><th>Interval in sec.</th></tr></thead><tbody>
<tr><td>Packagist.org</td><td>900</td></tr>
<tr><td>Lazy and API v2</td><td>1800</td></tr>
<tr><td>Lazy and API v1</td><td>7200</td></tr>
<tr><td>Full</td><td>86400</td></tr>
</tbody></table>
</div>
<h3 id="commands-for-debug"><a class="header" href="#commands-for-debug">Commands for Debug</a></h3>
<pre><code>php bin/console packagist:sync:mirrors firegento -vvv

Description:
  Sync mirror repository proxy.

Usage:
  packagist:sync:mirrors [options] [--] [&lt;mirror&gt;]

Arguments:
  mirror                Mirror name in config file.

Options:
      --force           Remote all data and sync again
  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug
</code></pre>
<h2 id="manual-approval-of-dependencies"><a class="header" href="#manual-approval-of-dependencies">Manual Approval of Dependencies</a></h2>
<p>By default, all new packages are automatically enabled and added to your repository when you run composer update. 
However, you can enable strict mode to use only approved packages and avoid including untrusted packages in your metadata. 
This can be useful in preventing dependency confusion attacks, especially if you use a 3rd-party Composer repository 
like <code>https://satis.oroinc.com/</code>. For more information on preventing dependency hacking, please see <a href="https://blog.packagist.com/preventing-dependency-hijacking">dependency confusion</a> </p>
<p>To enable strict mode, go to the Proxy Settings page and select Composer Proxies -&gt; Packagist (or any other name) -&gt; Settings.</p>
<p><a href="usage/../img/mirr1.png"><img src="usage/../img/mirr1.png" alt="strict" /></a></p>
<p>Next, go to the View Proxy page and click the &quot;Mass Mirror Packages&quot; button.</p>
<p><a href="usage/../img/mirr2.png"><img src="usage/../img/mirr2.png" alt="strict" /></a></p>
<h2 id="mirror-public-access"><a class="header" href="#mirror-public-access">Mirror Public Access</a></h2>
<p>Use the following configuration:</p>
<pre><code class="language-yaml">packeton:
    mirrors:
        youname:
            url: https://repo.example.org
            public_access: true
</code></pre>
<p><a href="usage/../img/mirr3.png"><img src="usage/../img/mirr3.png" alt="strict" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mirroring-and-composer-proxies-1"><a class="header" href="#mirroring-and-composer-proxies-1">Mirroring and Composer proxies</a></h1>
<p>Packeton can function as a proxy for the Composer repository, including which require authentication.
This feature can be used to grant all developers and clients access to private repositories such as Magento.
Additionally, it is possible to create ZIP archives from mirrored Git repositories of packages, in cases where HTTP dist
is unavailable.</p>
<h2 id="main-features-2"><a class="header" href="#main-features-2">Main Features</a></h2>
<ul>
<li>Supports full and lazy synchronization for small and large Composer repositories.</li>
<li>Supports the Packagist fast <code>metadata-changes-url</code> API.</li>
<li>Includes Strict Mode and Dependencies Approval functionality.</li>
<li>Supports Dist/SSH mirroring of source code.</li>
</ul>
<p>Example metadata with Strict mode and manual dependencies' approval.</p>
<pre><code class="language-json">{
    &quot;includes&quot;: {
        &quot;include-packeton/all$f05f56b8bd12d014a753cdbe6a7d749facd40908.json&quot;: {
            &quot;sha1&quot;: &quot;f05f56b8bd12d014a753cdbe6a7d749facd40908&quot;
        }
    },
    &quot;mirrors&quot;: [
        {
            &quot;dist-url&quot;: &quot;/mirror/orocrm/zipball/%package%/%version%/%reference%.%type%&quot;,
            &quot;preferred&quot;: true
        }
    ],
    &quot;metadata-url&quot;: &quot;/mirror/orocrm/p2/%package%.json&quot;,
    &quot;available-packages&quot;: [
        &quot;romanpitak/dotmailer-api-v2-client&quot;,
        &quot;oro/platform-enterprise&quot;,
        &quot;oro/crm-enterprise&quot;,
        &quot;oro/api-doc-bundle&quot;,
        &quot;oro/flotr2&quot;,
        &quot;oro/crm-pro-ldap-bundle&quot;,
        &quot;oro/multi-host&quot;,
        &quot;akeneo/batch-bundle&quot;
    ]
}
</code></pre>
<p>Original metadata is:</p>
<pre><code class="language-json">{
    &quot;packages&quot;: [],
    &quot;providers-url&quot;: &quot;/p/%package%$%hash%.json&quot;,
    &quot;providers&quot;: {
        &quot;actualys/drupal-commerce-connector-bundle&quot;: {
            &quot;sha256&quot;: &quot;4163f3b470b3b824cbcebee5a0d58ea3d516b7b5fa78617ba21120eeec9e494f&quot;
        },
        &quot;agencednd/oro-api-connector-bundle&quot;: {
            &quot;sha256&quot;: &quot;169c0963fd8442c190f2e9303e0e6fa1fe9ad0c9fb2f6782176d02e65a48eada&quot;
        },
        &quot;akeneo/batch-bundle&quot;: {
            &quot;sha256&quot;: &quot;4f2c1b9a43124524da45b35236acabd3ee1ad329980b885089e9eb408c1bca01&quot;
        },
    ...
    + 57 packages
</code></pre>
<p>For performance if composer user-agent == 1 then <code>includes</code> replaced with <code>providers-lazy-url</code></p>
<p><a href="usage/../img/packeton_proxies.png"><img src="usage/../img/packeton_proxies.png" alt="logo" /></a></p>
<h2 id="configuration-2"><a class="header" href="#configuration-2">Configuration</a></h2>
<p>Example how to enable proxies in your local configuration.
To enable proxies in your local configuration, create a file with any name
like <code>config/packages/any-name.yaml</code> and add the following configuration:</p>
<pre><code class="language-yaml">packeton:
    mirrors:
        packagist:
            url: https://repo.packagist.org
        orocrm:
            url: https://satis.oroinc.com/
            git_ssh_keys:
                git@github.com:oroinc: '/var/www/.ssh/private_key1'
                git@github.com:org2: '/var/www/.ssh/private_key2'
        example:
            url: https://satis.example.com/
            logo: 'https://example.com/logo.png'
            http_basic:
                username: 123
                password: 123
            public_access: true # Allow public access, default false
            sync_lazy: true # default false 
            enable_dist_mirror: false # default true
            available_package_patterns: # Additional restriction, but you can restrict it in UI
                - 'vend1/*' 
            available_packages:
                - 'pack1/name1' # but you can restrict it in UI
            composer_auth: '{&quot;auth.json...&quot;}' # JSON. auth.json to pass composer opts.
            sync_interval: 3600 # default auto.
            info_cmd_message: &quot;\n\u001b[37;44m#Слава\u001b[30;43mУкраїні!\u001b[0m\n\u001b[40;31m#Смерть\u001b[30;41mворогам\u001b[0m&quot; # Info message
</code></pre>
<p>The configuration allows you to use multiple SSH key settings for different GitHub accounts.</p>
<pre><code>...
git_ssh_keys:
    git@github.com:oroinc: '/var/www/.ssh/private_key1'
    git@github.com:org2: '/var/www/.ssh/private_key2'

# Or one key
git_ssh_keys: '/var/www/.ssh/private_key1'
</code></pre>
<h2 id="metadata-proxy-specification-1"><a class="header" href="#metadata-proxy-specification-1">Metadata Proxy Specification.</a></h2>
<p>The specification for the metadata proxy depends on the type of repository and the synchronization strategy being used.</p>
<div class="table-wrapper"><table><thead><tr><th>API</th><th>Full sync</th><th>Lazy sync</th><th>Mirroring (strict)</th></tr></thead><tbody>
<tr><td>V1</td><td>provider-includes (parent)</td><td>providers-lazy-url</td><td>includes</td></tr>
<tr><td>V2</td><td>meta v2 + available-packages (depends on size)</td><td>meta v2</td><td>meta v2 + available-packages</td></tr>
</tbody></table>
</div>
<h3 id="default-sync-intervals-1"><a class="header" href="#default-sync-intervals-1">Default sync intervals</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Repo</th><th>Interval in sec.</th></tr></thead><tbody>
<tr><td>Packagist.org</td><td>900</td></tr>
<tr><td>Lazy and API v2</td><td>1800</td></tr>
<tr><td>Lazy and API v1</td><td>7200</td></tr>
<tr><td>Full</td><td>86400</td></tr>
</tbody></table>
</div>
<h3 id="commands-for-debug-1"><a class="header" href="#commands-for-debug-1">Commands for Debug</a></h3>
<pre><code>php bin/console packagist:sync:mirrors firegento -vvv

Description:
  Sync mirror repository proxy.

Usage:
  packagist:sync:mirrors [options] [--] [&lt;mirror&gt;]

Arguments:
  mirror                Mirror name in config file.

Options:
      --force           Remote all data and sync again
  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug
</code></pre>
<h2 id="manual-approval-of-dependencies-1"><a class="header" href="#manual-approval-of-dependencies-1">Manual Approval of Dependencies</a></h2>
<p>By default, all new packages are automatically enabled and added to your repository when you run composer update. 
However, you can enable strict mode to use only approved packages and avoid including untrusted packages in your metadata. 
This can be useful in preventing dependency confusion attacks, especially if you use a 3rd-party Composer repository 
like <code>https://satis.oroinc.com/</code>. For more information on preventing dependency hacking, please see <a href="https://blog.packagist.com/preventing-dependency-hijacking">dependency confusion</a> </p>
<p>To enable strict mode, go to the Proxy Settings page and select Composer Proxies -&gt; Packagist (or any other name) -&gt; Settings.</p>
<p><a href="usage/../img/mirr1.png"><img src="usage/../img/mirr1.png" alt="strict" /></a></p>
<p>Next, go to the View Proxy page and click the &quot;Mass Mirror Packages&quot; button.</p>
<p><a href="usage/../img/mirr2.png"><img src="usage/../img/mirr2.png" alt="strict" /></a></p>
<h2 id="mirror-public-access-1"><a class="header" href="#mirror-public-access-1">Mirror Public Access</a></h2>
<p>Use the following configuration:</p>
<pre><code class="language-yaml">packeton:
    mirrors:
        youname:
            url: https://repo.example.org
            public_access: true
</code></pre>
<p><a href="usage/../img/mirr3.png"><img src="usage/../img/mirr3.png" alt="strict" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mirroring-and-composer-proxies-2"><a class="header" href="#mirroring-and-composer-proxies-2">Mirroring and Composer proxies</a></h1>
<p>Packeton can function as a proxy for the Composer repository, including which require authentication.
This feature can be used to grant all developers and clients access to private repositories such as Magento.
Additionally, it is possible to create ZIP archives from mirrored Git repositories of packages, in cases where HTTP dist
is unavailable.</p>
<h2 id="main-features-3"><a class="header" href="#main-features-3">Main Features</a></h2>
<ul>
<li>Supports full and lazy synchronization for small and large Composer repositories.</li>
<li>Supports the Packagist fast <code>metadata-changes-url</code> API.</li>
<li>Includes Strict Mode and Dependencies Approval functionality.</li>
<li>Supports Dist/SSH mirroring of source code.</li>
</ul>
<p>Example metadata with Strict mode and manual dependencies' approval.</p>
<pre><code class="language-json">{
    &quot;includes&quot;: {
        &quot;include-packeton/all$f05f56b8bd12d014a753cdbe6a7d749facd40908.json&quot;: {
            &quot;sha1&quot;: &quot;f05f56b8bd12d014a753cdbe6a7d749facd40908&quot;
        }
    },
    &quot;mirrors&quot;: [
        {
            &quot;dist-url&quot;: &quot;/mirror/orocrm/zipball/%package%/%version%/%reference%.%type%&quot;,
            &quot;preferred&quot;: true
        }
    ],
    &quot;metadata-url&quot;: &quot;/mirror/orocrm/p2/%package%.json&quot;,
    &quot;available-packages&quot;: [
        &quot;romanpitak/dotmailer-api-v2-client&quot;,
        &quot;oro/platform-enterprise&quot;,
        &quot;oro/crm-enterprise&quot;,
        &quot;oro/api-doc-bundle&quot;,
        &quot;oro/flotr2&quot;,
        &quot;oro/crm-pro-ldap-bundle&quot;,
        &quot;oro/multi-host&quot;,
        &quot;akeneo/batch-bundle&quot;
    ]
}
</code></pre>
<p>Original metadata is:</p>
<pre><code class="language-json">{
    &quot;packages&quot;: [],
    &quot;providers-url&quot;: &quot;/p/%package%$%hash%.json&quot;,
    &quot;providers&quot;: {
        &quot;actualys/drupal-commerce-connector-bundle&quot;: {
            &quot;sha256&quot;: &quot;4163f3b470b3b824cbcebee5a0d58ea3d516b7b5fa78617ba21120eeec9e494f&quot;
        },
        &quot;agencednd/oro-api-connector-bundle&quot;: {
            &quot;sha256&quot;: &quot;169c0963fd8442c190f2e9303e0e6fa1fe9ad0c9fb2f6782176d02e65a48eada&quot;
        },
        &quot;akeneo/batch-bundle&quot;: {
            &quot;sha256&quot;: &quot;4f2c1b9a43124524da45b35236acabd3ee1ad329980b885089e9eb408c1bca01&quot;
        },
    ...
    + 57 packages
</code></pre>
<p>For performance if composer user-agent == 1 then <code>includes</code> replaced with <code>providers-lazy-url</code></p>
<p><a href="usage/../img/packeton_proxies.png"><img src="usage/../img/packeton_proxies.png" alt="logo" /></a></p>
<h2 id="configuration-3"><a class="header" href="#configuration-3">Configuration</a></h2>
<p>Example how to enable proxies in your local configuration.
To enable proxies in your local configuration, create a file with any name
like <code>config/packages/any-name.yaml</code> and add the following configuration:</p>
<pre><code class="language-yaml">packeton:
    mirrors:
        packagist:
            url: https://repo.packagist.org
        orocrm:
            url: https://satis.oroinc.com/
            git_ssh_keys:
                git@github.com:oroinc: '/var/www/.ssh/private_key1'
                git@github.com:org2: '/var/www/.ssh/private_key2'
        example:
            url: https://satis.example.com/
            logo: 'https://example.com/logo.png'
            http_basic:
                username: 123
                password: 123
            public_access: true # Allow public access, default false
            sync_lazy: true # default false 
            enable_dist_mirror: false # default true
            available_package_patterns: # Additional restriction, but you can restrict it in UI
                - 'vend1/*' 
            available_packages:
                - 'pack1/name1' # but you can restrict it in UI
            composer_auth: '{&quot;auth.json...&quot;}' # JSON. auth.json to pass composer opts.
            sync_interval: 3600 # default auto.
            info_cmd_message: &quot;\n\u001b[37;44m#Слава\u001b[30;43mУкраїні!\u001b[0m\n\u001b[40;31m#Смерть\u001b[30;41mворогам\u001b[0m&quot; # Info message
</code></pre>
<p>The configuration allows you to use multiple SSH key settings for different GitHub accounts.</p>
<pre><code>...
git_ssh_keys:
    git@github.com:oroinc: '/var/www/.ssh/private_key1'
    git@github.com:org2: '/var/www/.ssh/private_key2'

# Or one key
git_ssh_keys: '/var/www/.ssh/private_key1'
</code></pre>
<h2 id="metadata-proxy-specification-2"><a class="header" href="#metadata-proxy-specification-2">Metadata Proxy Specification.</a></h2>
<p>The specification for the metadata proxy depends on the type of repository and the synchronization strategy being used.</p>
<div class="table-wrapper"><table><thead><tr><th>API</th><th>Full sync</th><th>Lazy sync</th><th>Mirroring (strict)</th></tr></thead><tbody>
<tr><td>V1</td><td>provider-includes (parent)</td><td>providers-lazy-url</td><td>includes</td></tr>
<tr><td>V2</td><td>meta v2 + available-packages (depends on size)</td><td>meta v2</td><td>meta v2 + available-packages</td></tr>
</tbody></table>
</div>
<h3 id="default-sync-intervals-2"><a class="header" href="#default-sync-intervals-2">Default sync intervals</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Repo</th><th>Interval in sec.</th></tr></thead><tbody>
<tr><td>Packagist.org</td><td>900</td></tr>
<tr><td>Lazy and API v2</td><td>1800</td></tr>
<tr><td>Lazy and API v1</td><td>7200</td></tr>
<tr><td>Full</td><td>86400</td></tr>
</tbody></table>
</div>
<h3 id="commands-for-debug-2"><a class="header" href="#commands-for-debug-2">Commands for Debug</a></h3>
<pre><code>php bin/console packagist:sync:mirrors firegento -vvv

Description:
  Sync mirror repository proxy.

Usage:
  packagist:sync:mirrors [options] [--] [&lt;mirror&gt;]

Arguments:
  mirror                Mirror name in config file.

Options:
      --force           Remote all data and sync again
  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug
</code></pre>
<h2 id="manual-approval-of-dependencies-2"><a class="header" href="#manual-approval-of-dependencies-2">Manual Approval of Dependencies</a></h2>
<p>By default, all new packages are automatically enabled and added to your repository when you run composer update. 
However, you can enable strict mode to use only approved packages and avoid including untrusted packages in your metadata. 
This can be useful in preventing dependency confusion attacks, especially if you use a 3rd-party Composer repository 
like <code>https://satis.oroinc.com/</code>. For more information on preventing dependency hacking, please see <a href="https://blog.packagist.com/preventing-dependency-hijacking">dependency confusion</a> </p>
<p>To enable strict mode, go to the Proxy Settings page and select Composer Proxies -&gt; Packagist (or any other name) -&gt; Settings.</p>
<p><a href="usage/../img/mirr1.png"><img src="usage/../img/mirr1.png" alt="strict" /></a></p>
<p>Next, go to the View Proxy page and click the &quot;Mass Mirror Packages&quot; button.</p>
<p><a href="usage/../img/mirr2.png"><img src="usage/../img/mirr2.png" alt="strict" /></a></p>
<h2 id="mirror-public-access-2"><a class="header" href="#mirror-public-access-2">Mirror Public Access</a></h2>
<p>Use the following configuration:</p>
<pre><code class="language-yaml">packeton:
    mirrors:
        youname:
            url: https://repo.example.org
            public_access: true
</code></pre>
<p><a href="usage/../img/mirr3.png"><img src="usage/../img/mirr3.png" alt="strict" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-authentication"><a class="header" href="#user-authentication">User Authentication</a></h1>
<p>Packeton may support multiple methods of authenticating users. It can additionally be extended to support 
custom authentication schemes.</p>
<h2 id="web-user-authentication"><a class="header" href="#web-user-authentication">Web User authentication</a></h2>
<p>Included in packeton is support for authenticating users via:</p>
<ul>
<li>A username and password.</li>
<li>An email address and password.</li>
</ul>
<p>But possible to enable LDAP only via configuration, see <a href="./authentication-ldap.html">ldap authentication</a></p>
<h2 id="composer-api-authentication"><a class="header" href="#composer-api-authentication">Composer API authentication</a></h2>
<p>Packeton is support API authentication only with api token. Password usage is not allowed. 
You can see api token in thr user profile menu.</p>
<p>Support for authenticating users via:</p>
<ul>
<li>HTTP Basic Authentication (username and api token)</li>
<li>Short query param <code>token</code> = <code>username:apiToken</code></li>
<li>Default packagist hook API (query params: <code>username</code> = username, <code>apiToken</code> = apiToken) </li>
</ul>
<p>Your customer needs to authenticate to access their Composer repository:
The simplest way to provide your credentials is providing your set of credentials inline with the repository specification such as:</p>
<pre><code class="language-json">{
    &quot;repositories&quot;: [
        {
            &quot;type&quot;: &quot;composer&quot;,
            &quot;url&quot;: &quot;https://&lt;username&gt;:&lt;api_token&gt;@example.org&quot;
        }
    ]
}
</code></pre>
<p>When you don't want to hard code your credentials into your composer.json, you can set up it global.</p>
<pre><code>composer config --global --auth http-basic.example.org username api_token
</code></pre>
<p>Example API call.</p>
<pre><code>curl https://example.com/packages/list.json
   -u &quot;username:apiToken&quot;
</code></pre>
<pre><code>curl https://example.com/packages/list.json?token=username:apiToken
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="jwt-api-authentication"><a class="header" href="#jwt-api-authentication">JWT API Authentication</a></h1>
<p>By default, packeton is storage api tokens in database for each user. But when user 
loaded from custom user provider, like LDAP need to enable JWT configuration to use API. So Packeton can be 
configured with a non-standard login type to support <a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Tokens</a>.</p>
<p>The JSON Web Token integration in Packeton uses the <a href="https://github.com/firebase/php-jwt">Firebase library</a>.
Also, JWT authentication can be enabled only for API.</p>
<p>Add <code>yaml</code> configuration file to path <code>config/packages/</code>, for example <code>config/packages/jwt.yaml</code> to enable it.</p>
<pre><code class="language-yaml">packeton:
    jwt_authentication:
        private_key: '%kernel.project_dir%/var/jwt/eddsa-key.pem'
        public_key: '%kernel.project_dir%/var/jwt/eddsa-public.pem'
</code></pre>
<p>Full configurations: </p>
<pre><code class="language-yaml"># config/packages/config/packages/jwt.yaml
packeton:
    jwt_authentication:
        private_key: '%kernel.project_dir%/var/jwt/eddsa-key.pem' # required for token sign
        public_key: '%kernel.project_dir%/var/jwt/eddsa-public.pem' # required for token verification
        passphrase: ~
        algo: EdDSA # Sign algo, here libsodium EdDSA
</code></pre>
<h2 id="generate-the-publicprivate-keys"><a class="header" href="#generate-the-publicprivate-keys">Generate the public/private keys</a></h2>
<pre><code>bin/console packagist:jwt:generate-keypair

bin/console packagist:jwt:generate-keypair --overwrite
</code></pre>
<p>Available options:</p>
<ul>
<li>--overwrite will overwrite your keys if they already exist.</li>
</ul>
<p>If keys already exists, a warning message will be raised to prevent you from overwriting your keys accidentally.</p>
<h3 id="jwt-token-ttl"><a class="header" href="#jwt-token-ttl">JWT Token TTL.</a></h3>
<p>JWT Token is never expire. It was done for compatibility with composer basic HTTP authorization.
Each time the api is called, Packeton is checked that the user exists in the database and that 
he has the same set of permissions and roles. </p>
<h3 id="digital-signatures-algos"><a class="header" href="#digital-signatures-algos">Digital signatures algos.</a></h3>
<p>We support all algos from Firebase lib: HMAC, OpenSSL RSA, OpenSSL</p>
<p>Rsa, HMAC, EdDSA algorithms generate invariant tokens, i.e. the value of the token will be constant for the same user.
It might be convenient as the app does not store the generated tokens. </p>
<p>Example how to change algo:</p>
<pre><code class="language-yaml">packeton:
    jwt_authentication:
    ...
        algo: RS256 # RSA 256
</code></pre>
<h3 id="generating-keys-using-openssl"><a class="header" href="#generating-keys-using-openssl">Generating keys using OpenSSL</a></h3>
<p>Example, how to generate an RSA private key, <code>key.pem</code> - private key. <code>public.pem</code> - public</p>
<pre><code>openssl genrsa -out key.pem 2048
openssl rsa -in key.pem -outform PEM -pubout -out public.pem
</code></pre>
<p>Example, how to generate an ES256 (elliptic curve) key pairs.</p>
<pre><code>openssl ecparam -name prime256v1 -genkey -noout -out key.pem
openssl ec -in key.pem -pubout -out public.pem
</code></pre>
<h2 id="obtain-the-token"><a class="header" href="#obtain-the-token">Obtain the token</a></h2>
<p>You can run command <code>packagist:user:manager</code> to show the api token:</p>
<pre><code>bin/console packagist:user:manager admin --show-token --token-format=jwt
</code></pre>
<p>Or you can found api token on your profile page. </p>
<p><a href="img/jwt_keys.png"><img src="img/jwt_keys.png" alt="Keys" /></a></p>
<h3 id="use-the-token"><a class="header" href="#use-the-token">Use the token</a></h3>
<p>Simply use the JWT, like standard API token for composer api.</p>
<h4 id="cache-ldap-user-loading"><a class="header" href="#cache-ldap-user-loading">Cache LDAP user loading.</a></h4>
<p>Since 2.0 composer downloads all packages in parallel, it may run more 12 request at the same time. 
To prevent calls external LDAP provider each time for JWT token verify, the obtained LDAP user object
placed to cache with 60 sec TTL. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="authenticating-against-an-ldap-server"><a class="header" href="#authenticating-against-an-ldap-server">Authenticating against an LDAP server</a></h1>
<p>You can enable LDAP authenticating only on configuration level.</p>
<p>Packeton has pre-installed Symfony LDAP component. Add the file <code>config/packages/ldap.yaml</code> to enable LDAP 
with following content. See LDAP in <a href="https://symfony.com/doc/current/security/ldap.html">Symfony Docs</a></p>
<pre><code class="language-yaml">parameters:
    default_login_provider: 'form_login_ldap'
    default_login_options:
        provider: all_users
        login_path: /login
        use_forward: false
        check_path: /login
        failure_path: null
        service: Symfony\Component\Ldap\Ldap
        dn_string: 'uid={username},dc=example,dc=com'

services:
    Symfony\Component\Ldap\Ldap:
        arguments: ['@Symfony\Component\Ldap\Adapter\ExtLdap\Adapter']
        tags:
            - ldap

    Symfony\Component\Ldap\Adapter\ExtLdap\Adapter:
        arguments:
            -   host: ldap.forumsys.com
                port: 389

security:
    providers:
        users_ldap:
            ldap:
                service: Symfony\Component\Ldap\Ldap
                base_dn: dc=example,dc=com
                search_dn: &quot;cn=read-only-admin,dc=example,dc=com&quot;
                search_password: password
                default_roles: ROLE_MAINTAINER
                uid_key: uid

        all_users:
            chain:
                providers: ['packagist', 'users_ldap']
</code></pre>
<p>Here is working example where used test <code>ldap.forumsys.com</code> server https://www.forumsys.com/2022/05/10/online-ldap-test-server/</p>
<p>Using LDAP integration does not prevent you from creating user manually from CLI and assign more accessible roles.
At the same LDAP password validation will be done on LDAP server side, because <code>CheckLdapCredentialsListener</code> has higher priority 
loading than default check listener. Therefore, if user is not enable in LDAP - it will not able login to packeton. </p>
<h2 id="user-providers-priority"><a class="header" href="#user-providers-priority">User providers priority.</a></h2>
<p>Packeton use Symfony <a href="https://symfony.com/doc/current/security/user_providers.html#chain-user-provider">Chain User Provider</a>
to lookup users.</p>
<p>If you want to use customer user restriction by vendors and versions, <code>packagist</code> user provider must load before ldap.</p>
<pre><code class="language-yaml">security:
    providers:
        users_ldap:
            ldap:
                ... 
 
        all_users:
            chain:
                providers: ['packagist', 'users_ldap'] # Load user/roles form default packagist and if not found - use ldap user
                providers: ['users_ldap', 'packagist'] # packagist users will be ignore 
</code></pre>
<h2 id="load-different-roles-from-ldap"><a class="header" href="#load-different-roles-from-ldap">Load different roles from LDAP.</a></h2>
<p>You can use more 1 user providers:</p>
<pre><code class="language-yaml">security:
    providers:
        users_ldap:
            ldap:
                service: Symfony\Component\Ldap\Ldap
                base_dn: dc=example,dc=com
                search_dn: &quot;cn=read-only-admin,dc=example,dc=com&quot;
                filter: &quot;(&amp;(objectclass=groupOfUniqueNames)(ou=scientists)(uniqueMember=uid={username},dc=example,dc=com))&quot;
                search_password: password
                default_roles: ROLE_MAINTAINER
                uid_key: uid

        users_ldap_admin:
            ldap:
                service: Symfony\Component\Ldap\Ldap
                base_dn: dc=example,dc=com
                search_dn: &quot;cn=read-only-admin,dc=example,dc=com&quot;
                filter: &quot;(&amp;(objectclass=groupOfUniqueNames)(ou=mathematicians)(uniqueMember=uid={username},dc=example,dc=com))&quot;
                search_password: password
                default_roles: ROLE_ADMIN
                uid_key: uid

        all_users:
            chain:
                providers: ['packagist', 'users_ldap', 'users_ldap_admin']
</code></pre>
<p>Here test example where exists two Groups (ou) that include:</p>
<ul>
<li>ou=mathematicians,dc=example,dc=com - assign role ROLE_ADMIN</li>
<li>ou=scientists,dc=example,dc=com - assign role ROLE_MAINTAINER</li>
</ul>
<h2 id="api-authentication-with-ldap-users"><a class="header" href="#api-authentication-with-ldap-users">API authentication with LDAP users.</a></h2>
<p>By default, packeton is storage api token in database for each user. 
But if the user was loaded by custom external users' provider, but from the database, you will need enable JWT configuration.
See <a href="authentication-jwt.html">JWT Configuration</a></p>
<h2 id="enable-ldap-for-docker-runtime"><a class="header" href="#enable-ldap-for-docker-runtime">Enable LDAP for docker runtime.</a></h2>
<p>You can use docker volume to share own configuration to application.</p>
<pre><code>...
        volumes:
            - .docker:/data
            - ${PWD}/ldap.yaml:/var/www/packagist/config/packages/ldap.yaml
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="s3-storage-provider"><a class="header" href="#s3-storage-provider">S3 Storage Provider</a></h1>
<p>By default, Packeton stores packages archives on the local filesystem. But you can easily configure 
the S3 using <code>league/flysystem-bundle</code>.</p>
<p>For docker env, please set env vars. </p>
<pre><code>STORAGE_SOURCE=s3
STORAGE_AWS_BUCKET=packeton-bucket
STORAGE_AWS_PREFIX=packeton
STORAGE_AWS_ARTIFACT_PREFIX=artifact

STORAGE_AWS_ARGS='{&quot;endpoint&quot;: &quot;https://s3.waw.io.cloud.ovh.net&quot;, &quot;accessKeyId&quot;: &quot;xxx&quot;, &quot;accessKeySecret&quot;: &quot;xxx&quot;, &quot;region&quot;: &quot;waw&quot;}'
</code></pre>
<p>Sometimes for Artifact Repository requires direct access to files from the archive, so to 
improve performance and reduces count of S3 API requests, the all archives are cached on the local filesystem too. </p>
<p>If you need to use the other provider, like Google Cloud, you may add config file to <code>config/packages</code> or use <code>config.yaml</code> in data docker dir.</p>
<pre><code class="language-yaml">flysystem:
    storages:
        s3_v2.storage:
            adapter: 'asyncaws'
            options:
                client: 'packeton.s3.storage'
                bucket: '%env(STORAGE_AWS_BUCKET)%'
                prefix: '%env(STORAGE_AWS_PREFIX)%'

        s3_v2.artifact:
            adapter: 'asyncaws'
            options:
                client: 'packeton.s3.storage'
                bucket: '%env(STORAGE_AWS_BUCKET)%'
                prefix: '%env(STORAGE_AWS_ARTIFACT_PREFIX)%'

        gcloud.storage:
            adapter: 'gcloud'
            options:
                client: 'gcloud_client_service' 
                bucket: 'bucket_name'
                prefix: 'optional/path/prefix'

        gcloud.artifact:
            adapter: 'gcloud'
            options:
                client: 'gcloud_client_service' 
                bucket: 'bucket_name'
                prefix: 'optional/path/artifact'

parameters:
    env(STORAGE_AWS_BUCKET): 'packeton-bucket'
    env(STORAGE_AWS_PREFIX): 'packeton'
    env(STORAGE_AWS_ARGS): '[]'
    env(STORAGE_AWS_ARTIFACT_PREFIX): 'artifact'

services:
    packeton.s3.storage:
        class: AsyncAws\S3\S3Client
        arguments:
            $configuration: '%env(json:STORAGE_AWS_ARGS)%'
            $httpClient: '@Symfony\Contracts\HttpClient\HttpClientInterface'
            $logger: '@logger'
    
    gcloud_client_service:
        class: Google\Cloud\Storage\StorageClient
        arguments:
            - { keyFilePath: 'path/to/keyfile.json' }
</code></pre>
<pre><code>STORAGE_SOURCE=s3_v2
STORAGE_SOURCE=gcloud
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-landing-page"><a class="header" href="#custom-landing-page">Custom landing page</a></h1>
<p>If you are distributing packages to your customers, 
you may want to create a separate domain for Composer metadata-only to hide 
the default web interface and login page.</p>
<p>Add following lines to you configuration. <code>config.yaml or config/packages/*.yaml</code></p>
<pre><code class="language-yaml">packeton:
    web_protection:
        ## Multi host protection, disable web-ui if host !== app.example.com and ips != 127.0.0.1, 10.9.1.0/24
        ## But the repo metadata will be available for all hosts and ips.
        repo_hosts: ['*', '!app.example.com']
        allow_ips: '127.0.0.1, 10.9.1.0/24'
        status_code: 402
        custom_page: &gt; # Custom landing non-auth page. Path or HTML
            &lt;html&gt;
            &lt;head&gt;&lt;title&gt;402 Payment Required&lt;/title&gt;&lt;/head&gt;
            &lt;body&gt;
            &lt;center&gt;&lt;h1&gt;402 Payment Required&lt;/h1&gt;&lt;/center&gt;
            &lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
            &lt;/body&gt;
            &lt;/html&gt;
</code></pre>
<p>Where <code>custom_page</code> html content or path to html page.</p>
<p>Here all hosts will be hidden under this page (if ip is not match or host != app.example.com). </p>
<p><code>app.example.com</code> - this is host for default Web-UI.</p>
<h3 id="example-2"><a class="header" href="#example-2">Example 2</a></h3>
<pre><code class="language-yaml">    web_protection: 
        repo_hosts: ['repo.example.com']
</code></pre>
<p>Here Web-UI will be hidden for <code>repo_hosts</code> host <code>repo.example.com</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="security-monitoring"><a class="header" href="#security-monitoring">Security Monitoring</a></h1>
<p>Security Monitoring allow to send notifications when found a security problem in your <code>composer.lock</code>. By default, used packagist.org database.</p>
<p>Packeton is automatically check the main branch of every repository if the <code>composer.lock</code> is exists. 
You need to configure notifications webhook to receive notification if found a new security issue. 
Also, you may see list of security advisories in the package page.</p>
<p><a href="usage/../img/security.png"><img src="usage/../img/security.png" alt="logo" /></a></p>
<h2 id="configure-webhook-notifications"><a class="header" href="#configure-webhook-notifications">Configure Webhook Notifications</a></h2>
<p>Go to Webhook page and click the &quot;Add Webhook&quot;. Please fill the form.</p>
<div class="table-wrapper"><table><thead><tr><th><em>Form</em></th><th><em>Description</em></th></tr></thead><tbody>
<tr><td>Name</td><td>Any name</td></tr>
<tr><td>Url</td><td>Target url address. For example https://api.telegram.org/bot${secrets.TOKEN}/sendMessage</td></tr>
<tr><td>Method</td><td>POST</td></tr>
<tr><td>Request options</td><td>Symfony HTTP client options (like custom headers, auth) JSON</td></tr>
<tr><td>Payload</td><td>Twig render payload</td></tr>
</tbody></table>
</div>
<p>For example request payload for telegram. It will send JSON request, because <code>response</code> is array</p>
<pre><code class="language-twig">{% set text = &quot;New security issue *#{package.name}*\n\n&quot; %}
{% for advisory in advisories %}
    {% set text = text ~ &quot;#{advisory.title}\nPackage: *#{advisory.packageName}* #{advisory.version}\n&quot; %}
    {% set text = text ~ (advisory.cve and advisory.link ? &quot;[#{advisory.cve}](#{advisory.link})\n&quot; : &quot;Advisory: #{advisory.advisoryId}\n&quot;) %}
    {% set text = text ~ &quot;Reported at: #{advisory.reportedAt}\n\n&quot; %}
{% endfor %}

{% set response = {
    'chat_id': '${secrets.CHART_ID}',
    'text': text,
    'parse_mode': 'Markdown'
} %}

{% return response %}
</code></pre>
<p>Twig vars:
<code>advisories</code> - list of advisories <code>Composer\Advisory\SecurityAdvisory</code>
<code>package</code> - package object.</p>
<p>Where <code>${secrets.CHART_ID}</code> <code>${secrets.TOKEN}</code> replace with secrets or hardcode this params. See <a href="usage/../webhook.html">webhooks</a> docs.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="migrate-from-packagistcom--satis"><a class="header" href="#migrate-from-packagistcom--satis">Migrate from Packagist.com / Satis</a></h1>
<p>Packeton import provide interface to fast mass import all private packages from your own composer repository, 
like Satis/Packagist. also you may use oauth2 integration to import all packages from your VCS hosting</p>
<p><a href="usage/../img/import.png"><img src="usage/../img/import.png" alt="import" /></a></p>
<p>Where</p>
<ul>
<li><code>Glob package filter</code> - List of Glob to filter by package vendor name.</li>
</ul>
<p>Example input value:</p>
<pre><code>okvpn/*
org1/*
</code></pre>
<ul>
<li><code>Select only packages (default all packages in the repository)</code> - used if composer repository does not provide API to fetch list of all packages. 
Put your composer.json, composer.lock, composer info output or packages names separated by spaces or line break</li>
</ul>
<p>Example input value:</p>
<pre><code>sebastian/cli-parser               2.0.0   Library for parsing CLI options
sebastian/code-unit                2.0.0   Collection of value objects that represent the PHP code units
sebastian/code-unit-reverse-lookup 3.0.0   Looks up which function or method a line of code belongs to
sebastian/comparator               5.0.1   Provides the functionality to compare PHP values for equality
sebastian/complexity               3.0.1   Library for calculating the complexity of PHP code units
sebastian/diff                     5.0.3   Diff implementation
sebastian/environment              6.0.1   Provides functionality to handle HHVM/PHP environments
sebastian/exporter                 5.0.0   Provides the functionality to export PHP variables for visualization
sebastian/global-state             6.0.1   Snapshotting of global state
sebastian/lines-of-code            2.0.1   Library for counting the lines of code in PHP source code
</code></pre>
<ul>
<li><code>Clone preference</code> - used to select URL format. SSH or HTTPs clone.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="oauth2-and-sync-integrations"><a class="header" href="#oauth2-and-sync-integrations">OAuth2 and Sync integrations</a></h1>
<h2 id="table-of-content-1"><a class="header" href="#table-of-content-1">Table of content</a></h2>
<ul>
<li><a href="pull-request-review.html">Pull Request review</a></li>
<li><a href="oauth2/login-expression.html">Login Restriction</a></li>
<li><a href="oauth2/github-oauth.html">GitHub Setup</a></li>
<li><a href="oauth2/githubapp.html">GitHub App Setup</a></li>
<li><a href="oauth2/gitlab-integration.html">GitLab Setup</a></li>
<li><a href="oauth2/gitea.html">Gitea Setup</a></li>
<li><a href="oauth2/bitbucket.html">Bitbucket Setup</a></li>
</ul>
<h2 id="base-configuration-reference"><a class="header" href="#base-configuration-reference">Base configuration reference</a></h2>
<p>To enable OAuth2 integrations you need to add following configuration </p>
<pre><code class="language-yml">packeton:
    integrations:
        github: # Alias name 
            allow_login: true # default false 
            allow_register: false # default false 
            default_roles: ['ROLE_USER', 'ROLE_MAINTAINER', 'ROLE_GITLAB']
            
            clone_preference: 'api'
            repos_synchronization: true
            
            disable_hook_repos: false # disabled auto setup webhook
            disable_hook_org: false
            svg_logo: ~ # &lt;svg xmlns= logo
            logo: ~ # png logo
            login_title: Login or Register with GitHub
            description: ~

            login_control_expression: &quot;data['email'] ends with '@packeton.org'&quot; # Restrict logic/register by custom condition.
            login_control_expression_debug: false # help debugging    

            pull_request_review: true # Enable pull request composer.lock review. Default false
            webhook_url: ~ #overwrite host when setup webhooks

            github:
                client_id: 'xxx'
                client_secret: 'xxx'

        gitlab2:  # Alias name - may be any url safe value.
            base_url: 'https://gitlab.production.com/'
            clone_preference: 'clone_https' # Allows [api, clone_https, clone_ssh]
            gitlab: # Provider name: github, gitlab, bitbucket etc 
                client_id: 'xxx'
                client_secret: 'xxx'
                api_version: 'v4' # you may overwrite only for gitlab provider, default v4

        # Use GitHub APP JWT
        # See https://docs.github.com/en/apps/creating-github-apps/authenticating-with-a-github-app/about-authentication-with-a-github-app
        githubapp_main:
            repos_synchronization: true
            pull_request_review: true
            githubapp:
                private_key: '%kernel.project_dir%/var/packeton-private-key.pem'
                passphrase: ~ # private key pass
                app_id: 345472

        gitea:
            allow_login: true
            repos_synchronization: true
            pull_request_review: true
            base_url: 'https://gitea.packeton.com.ar/'
            gitea:
                client_id: '44000000-0000-0000-0000-00000000000'
                client_secret: 'gto_acxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'

        bitbucket:
            repos_synchronization: true
            pull_request_review: true
            bitbucket:
                key: GA7000000000000000
                secret: 9chxxxxxzxxxxxxxxeexxxxxxxxxxxxx
                api_version: ~ # '/example/rest/v2/' custom api prefix

        google:
            allow_login: true
            google:
                client_id: 'xxxxx.apps.googleusercontent.com'
                client_secret: 'xxxx'    

</code></pre>
<p>Where <code>clone_preference</code>:</p>
<ul>
<li><code>api</code> - Use api to get composer info</li>
<li><code>clone_https</code> - clone repo with using oauth api token</li>
<li><code>clone_ssh</code> - clone repo with system ssh key</li>
</ul>
<p><code>repos_synchronization</code> - If enabled, a new package will be automatically created when you will push to a new or exists repo that contains <code>composer.json</code> </p>
<h2 id="docker-env"><a class="header" href="#docker-env">Docker env.</a></h2>
<p>To make docker usage more easy, you can use env variables to configure basic settings for each integration without editing the <code>*.yaml</code> configs.</p>
<pre><code># GitLab
# OAUTH_GITLAB_CLIENT_ID=
# OAUTH_GITLAB_CLIENT_SECRET=
# OAUTH_GITLAB_BASE_URL=

# GitHub
# OAUTH_GITHUB_CLIENT_ID=
# OAUTH_GITHUB_CLIENT_SECRET=
# OAUTH_GITHUB_BASE_URL=

# Gitea 
# OAUTH_GITEA_CLIENT_ID=
# OAUTH_GITEA_CLIENT_SECRET=
# OAUTH_GITEA_BASE_URL=

# Bitbucket 
# OAUTH_BITBUCKET_CLIENT_ID=
# OAUTH_BITBUCKET_CLIENT_SECRET=
# OAUTH_BITBUCKET_BASE_URL=

# Google SSO
# OAUTH_GOOGLE_CLIENT_ID=
# OAUTH_GOOGLE_CLIENT_SECRET=
# OAUTH_GOOGLE_ALLOW_REGISTRATION=

# Additinal vars ${NAME} = GITLAB/GITHUB/ .. 
# OAUTH_*_DISABLE_ORG_HOOK=
# OAUTH_*_DISABLE_REP_HOOK=
# OAUTH_*_ALLOW_LOGIN=
# OAUTH_*_ALLOW_REGISTRATION=
</code></pre>
<h2 id="supported-3-d-provider"><a class="header" href="#supported-3-d-provider">Supported 3-d provider</a></h2>
<h3 id="github"><a class="header" href="#github">GitHub</a></h3>
<p>Scopes:</p>
<ul>
<li>login: <code>user:email</code></li>
<li>repositories: <code>read:org</code>, <code>repo</code></li>
</ul>
<p>Redirect Urls:</p>
<pre><code>https://example.com/
</code></pre>
<h3 id="gitlab"><a class="header" href="#gitlab">GitLab</a></h3>
<p>Scopes:</p>
<ul>
<li>login: <code>read_user</code></li>
<li>repositories: <code>api</code></li>
</ul>
<p>Redirect Urls:</p>
<pre><code>https://example.com/oauth2/{alias}/install
https://example.com/oauth2/{alias}/check
</code></pre>
<h4 id="gitlab-groups-webhooks-notices"><a class="header" href="#gitlab-groups-webhooks-notices">GitLab Groups Webhooks notices</a></h4>
<p>A group webhooks needed for synchronization a new package. 
They are triggered by events that occur across all projects in the group.
This feature enabled only for Premium / EE / Gold paid plan, but it can be replaced with GitLab Packagist Integration</p>
<p>You must manually setup this integration.</p>
<p><a href="img/gitlab.png"><img src="img/gitlab.png" alt="Gitlab" /></a></p>
<p>Where token you can find on the packeton integration view page. The token must have <code>whk</code> prefix 
to find related integration access token.</p>
<h3 id="gitea"><a class="header" href="#gitea">Gitea</a></h3>
<p>Scopes:</p>
<ul>
<li>login: <code>read:user</code></li>
<li>repositories: <code>organization</code>, <code>repository</code>, <code>write:issue</code></li>
</ul>
<p>Redirect Urls:</p>
<pre><code>https://example.com/oauth2/{alias}/auto
</code></pre>
<h3 id="bitbucket"><a class="header" href="#bitbucket">Bitbucket</a></h3>
<p>Scopes:</p>
<ul>
<li>repositories &amp; login: <code>account</code>, <code>webhook</code>, <code>team</code>, <code>project</code>, <code>pullrequest</code></li>
</ul>
<p>Redirect Urls:</p>
<pre><code>https://example.com/oauth2/{alias}/auto
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pull-request-composer-lock-review"><a class="header" href="#pull-request-composer-lock-review">Pull Request composer lock review</a></h1>
<p>Every time when you create a Pull Request with <code>composer.lock</code> changes, the Packeton add a comment with descriptions 
of changing dependencies. It detects the next of changes:</p>
<ul>
<li>Added a new dependency</li>
<li>Remove dependency</li>
<li>Downgrade dependency</li>
<li>Upgrades dependency.</li>
<li>Change dist or source url.</li>
</ul>
<p><a href="img/pr-review.png"><img src="img/pr-review.png" alt="PR review" /></a></p>
<h3 id="configure-pull-request-review"><a class="header" href="#configure-pull-request-review">Configure Pull Request Review.</a></h3>
<p>In the first you need add oauth integration. It may also GitHub app bot for GitHub hosting, see <a href="oauth2.html">oauth2</a>.</p>
<p>You must enable <code>pull_request_review</code> on configuration level. Or later you may enable per repository individually in the case then you 
don't use the integration synchronization.</p>
<pre><code class="language-yaml">packeton:
    integrations:
        github:
            pull_request_review: true
            githubapp:
                ...
</code></pre>
<p>Now the bot will add comments automatically if you use with integration synchronization. 
But for enable it manually only for one selected repository you need add webhook (<code>pull_request</code> score) with integration access token.</p>
<p>it may look like. you can found this on integration view page.</p>
<pre><code>https://example.com/api/hooks/gitlab/6?token=whk_810d6b279b3f78b758e09fe01f12378d2bd809c4
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="github-oauth2-setup"><a class="header" href="#github-oauth2-setup">GitHub OAuth2 Setup</a></h1>
<p>Go to you GitHub account Settings / Developer settings (<code>https://github.com/settings/developers</code>) and select &quot;New OAuth App&quot;</p>
<p>Use the packeton host as &quot;Callback URL / Redirect URL&quot;. For example <code>https://packeton.example.org</code></p>
<p><a href="oauth2/../img/github-oauth2.png"><img src="oauth2/../img/github-oauth2.png" alt="Groups" /></a></p>
<p>Use obtained <code>clinent_id</code>, <code>client_secret</code> to create configuration in yaml. For docker installation you may use <code>config.yaml</code> file in docker volume.</p>
<pre><code class="language-yaml">packeton:
    integrations:
        github: # any alias name 
            allow_login: true 
            ... more options see oauth2 md
            gitlab: # Provider name: github, gitlab, bitbucket etc 
                client_id: 'xxx'
                client_secret: 'xxx'
</code></pre>
<p>Now go to Packeton integration page and click Install Integration. You will see list of available integrations and its Redirect Urls</p>
<p>Click to Connect to set up oauth2 credentials</p>
<p><a href="oauth2/../img/github-connect.png"><img src="oauth2/../img/github-connect.png" alt="Groups" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="github-app-integration"><a class="header" href="#github-app-integration">GitHub App Integration</a></h1>
<p>GitHub App Integration is alternative of GitHub OAuth2. To create GitHub go to 
Settings / Developer settings / GitHub Apps and click New GitHub App.</p>
<p>Use the next &quot;Callback URL / Redirect URL&quot;.</p>
<p>Redirect Urls:</p>
<pre><code>https://example.com/oauth2/{alias}/install
https://example.com/oauth2/{alias}/check
</code></pre>
<p>The webhooks URL maybe any. We don't use it and setup webhooks per repository or choice organization.</p>
<p>Select Permissions: </p>
<ul>
<li>Webhooks read-write (Repository permissions)</li>
<li>Metadata (Repository permissions)</li>
<li>Pull requests read-write (Repository permissions)</li>
<li>Webhooks read-write (Organization permissions)</li>
<li>Members read (Organization permissions) - optional</li>
</ul>
<p><a href="oauth2/../img/githubapp1.png"><img src="oauth2/../img/githubapp1.png" alt="Img" /></a></p>
<p>After creating App go to App view page and find <code>app_id</code> and generate a &quot;Private Key&quot;</p>
<p>The next step is creating of configuration in yaml.
For docker installation you may use <code>config.yaml</code> file in docker volume.</p>
<pre><code class="language-yaml">packeton:
    integrations:
        github:
            repos_synchronization: true
            pull_request_review: true
            ... 
            githubapp:
                private_key: '/data/packeton-key.pem'
                app_id: 340120
</code></pre>
<p>When you must install GitHub App in you Github Account. Go to public App page, like <code>https://github.com/apps/{name}</code>
and click configure. Select you organization or own account.</p>
<p><a href="oauth2/../img/githubapp2.png"><img src="oauth2/../img/githubapp2.png" alt="Img" /></a></p>
<p>After install you will see <code>installation_id</code> on URL address. For example <code>https://github.com/settings/installations/38069000</code></p>
<p>Now go to Packeton integration page and click Install Integration. When click to Connect under you githubapp configuration.</p>
<p>To finish setup Go to Packeton integration view page / Settings and provider <code>installation_id</code> in the form</p>
<p><a href="oauth2/../img/githubapp3.png"><img src="oauth2/../img/githubapp3.png" alt="Img" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gitlab-integration-setup"><a class="header" href="#gitlab-integration-setup">GitLab Integration Setup</a></h1>
<p>Go to you GitLab account preferences (<code>https://gitlab.example.com/-/profile/preferences</code>) and select &quot;Applications&quot;</p>
<p><a href="oauth2/../img/gitlab-app.png"><img src="oauth2/../img/gitlab-app.png" alt="Groups" /></a></p>
<p>Redirect Urls:</p>
<pre><code>https://example.com/oauth2/{alias}/install
https://example.com/oauth2/{alias}/check
</code></pre>
<p>Select the <code>api</code>, <code>read_user</code>, <code>read_repository</code> scopes and save the new application. The redirect urls you may change later.</p>
<p>Use obtained <code>clinent_id</code>, <code>client_secret</code> to create configuration in yaml. For docker installation you may use <code>config.yaml</code> file in docker volume.</p>
<pre><code class="language-yaml">packeton:
    integrations:
        gitlab: # - {alias}
            base_url: 'https://gitlab.example.com/'
            clone_preference: 'clone_https' # Allows [api, clone_https, clone_ssh]
            ... more options see oauth2 md
            gitlab: # Provider name: github, gitlab, bitbucket etc 
                client_id: 'xxx'
                client_secret: 'xxx'
#                api_version: 'v4'
</code></pre>
<p>Now go to Packeton integration page and click Install Integration. You will see list of available integrations and its Redirect Urls</p>
<p>Click to Connect to setup oauth2 credentials</p>
<p><a href="oauth2/../img/gitlab-connect.png"><img src="oauth2/../img/gitlab-connect.png" alt="Groups" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gitea-integration-setup"><a class="header" href="#gitea-integration-setup">Gitea Integration Setup</a></h1>
<p>Go to you Gitea account settings (<code>https://git.example.com/user/settings/applications</code>) and select &quot;Applications&quot;.</p>
<p><a href="oauth2/../img/gitea.png"><img src="oauth2/../img/gitea.png" alt="Gitea" /></a></p>
<p>Redirect Urls:</p>
<pre><code>https://example.com/oauth2/{alias}/auto
</code></pre>
<p>The next step is obtain <code>clinent_id</code>, <code>client_secret</code> to creating a configuration in the yaml. 
For docker installation you may use <code>config.yaml</code> file in docker volume.</p>
<pre><code class="language-yaml">packeton:
    integrations:
        gitea:
            allow_login: true
            repos_synchronization: true
            pull_request_review: true
            base_url: 'https://git.example.com/'
            gitea:
                client_id: '44000000-0000-0000-0000-00000000000'
                client_secret: 'gto_acxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
#                api_version: 'v1'
</code></pre>
<p>Now you can go to the Packeton integration page and click &quot;Install Integration&quot;. 
You will see list of available integrations and its Redirect Urls. Click to Connect to set up oauth2 credentials</p>
<h4 id="example-of-pull-request-review"><a class="header" href="#example-of-pull-request-review">Example of pull request review</a></h4>
<p><a href="oauth2/../img/gitea2.png"><img src="oauth2/../img/gitea2.png" alt="Gitea2" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitbucket-integration-setup"><a class="header" href="#bitbucket-integration-setup">Bitbucket Integration Setup</a></h1>
<p>Go to you Bitbucket workspace settings (<code>https://bitbucket.org/{name}/workspace/settings/api</code>) and select &quot;Add OAuth consumer&quot;.</p>
<p><a href="oauth2/../img/bitbucket.png"><img src="oauth2/../img/bitbucket.png" alt="Bitbucket" /></a></p>
<p>Redirect Urls:</p>
<pre><code>https://example.com/oauth2/{alias}/auto
</code></pre>
<p>The next step is obtain <code>Key</code>, <code>Secret</code> to creating a configuration in the yaml.
For docker installation you may use <code>config.yaml</code> file in docker volume.</p>
<pre><code class="language-yaml">packeton:
    integrations:
        bitbucket:
            repos_synchronization: true
            pull_request_review: true
            bitbucket:
                key: GA7000000000000000
                secret: 9chxxxxxzxxxxxxxxeexxxxxxxxxxxxx
</code></pre>
<p>Now you can go to the Packeton integration page and click &quot;Install Integration&quot;.
You will see list of available integrations and its Redirect Urls. Click to Connect to set up oauth2 credentials.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="limit-loginregister-with-using-expression-lang"><a class="header" href="#limit-loginregister-with-using-expression-lang">Limit login/register with using expression lang</a></h1>
<p>You may limit login with using expression, like symfony expression for access control. For evaluate expression
used TWIG engine with customization by this lib <a href="https://github.com/okvpn/expression-language">okvpn/expression-language</a>.
It allows to create a complex expressions where called team/members API to check that user belong to Organization/Repos etc.</p>
<p>Example usage </p>
<pre><code class="language-yaml">packeton:
    integrations:
        github:
            allow_login: true
            allow_register: true
            github:
                client_id: 'xxx'
                client_secret: 'xxx'
            login_control_expression: &quot;data['email'] ends with '@packeton.org'&quot;
</code></pre>
<p>Example 2. Here check GitLab's groups API.</p>
<pre><code class="language-yaml">packeton:
    integrations:
        gitlab:
            allow_login: true
            allow_register: true
            gitlab:
                client_id: 'xx'
                client_secret: 'xx'
            login_control_expression: &gt;
                {% set members = api_cget('/groups/balaba/members') %}
                {% set found = null %}
                {% for member in members %}
                    {% if data['username'] and data['username'] == member['username'] %}
                        {% set found = member %}
                    {% endif %}
                {% endfor %}
    
                {% if found['access_level'] &gt;= 50 %}
                    {% return ['ROLE_ADMIN', 'ROLE_GITLAB'] %}
                {% elseif found['access_level'] &gt;= 40 %}
                    {% return ['ROLE_MAINTAINER', 'ROLE_GITLAB'] %}
                {% elseif found['access_level'] &gt;= 10 %}
                    {% return ['ROLE_USER', 'ROLE_GITLAB'] %}
                {% endif %}
                {% return [] %}
</code></pre>
<h3 id="custom-twig-function-for-expression-lang"><a class="header" href="#custom-twig-function-for-expression-lang">Custom Twig function for expression lang</a></h3>
<ul>
<li><code>api_get(url, query = [], cache = true, app = null)</code> - Call get method </li>
<li><code>api_cget(url, query = [], cache = true, app = null)</code> - Call get method with pagination with all pages.</li>
</ul>
<p>By default, the API call results are cached, but you may overwrite with <code>cache</code> param.</p>
<p><code>login_control_expression</code> - may return a bool result or list of roles. If returned result is empty - login/register is not allowed.</p>
<h2 id="debug-expressions"><a class="header" href="#debug-expressions">Debug expressions</a></h2>
<p>You may enable debugging by param</p>
<pre><code class="language-yaml">packeton:
    integrations:
        gitlab:
            login_control_expression_debug: true
            login_control_expression: &quot;data['email'] ends with '@packeton.org'&quot;
</code></pre>
<p>For localhost, you also can enable symfony dev env. But it's <strong>strongly</strong>  not recommended for prod for security reasons.
Then you may use <code>dump</code> action.</p>
<pre><code>APP_ENV=dev
</code></pre>
<pre><code class="language-twig">{% set members = api_cget('/groups/balaba/members') %}
{% set found = null %}
{% for member in members %}
    {% if data['username'] and data['username'] == member['username'] %}
        {% set found = member %}
    {% endif %}
{% endfor %}
{% do dump(members) %}
{% do dump(found) %}

{% return [] %}
</code></pre>
<h4 id="example-debug-panel"><a class="header" href="#example-debug-panel">Example debug panel</a></h4>
<p>When <code>login_control_expression_debug</code> is enabled you may evaluate script from UI.</p>
<p><a href="oauth2/../img/debug-expr.png"><img src="oauth2/../img/debug-expr.png" alt="Img" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>Everyone is welcome to contribute code to <a href="https://github.com/vtsykun/packeton.git">https://github.com/vtsykun/packeton.git</a></p>
<h3 id="1-development-environment"><a class="header" href="#1-development-environment">1. Development environment.</a></h3>
<p>If you are running Windows, the Windows Subsystem for Linux (WSL) is recommended for development.
But the most of the features will work on Windows too.
The code of Packeton is written in PHP.</p>
<h4 id="requirements-1"><a class="header" href="#requirements-1">Requirements</a></h4>
<ul>
<li>PHP 8.1+</li>
<li>Redis (or Docker) for some functionality.</li>
<li>(optional) nginx / php-fpm to run the web server.</li>
<li>(optional) MySQL or PostgresSQL for the main data store, default SQLite.</li>
</ul>
<h3 id="2-get-the-source"><a class="header" href="#2-get-the-source">2. Get the source.</a></h3>
<p>Make a fork on GitHub, and then create a pull request to provide your changes.</p>
<pre><code>git clone git@github.com:YOUR_GITHUB_NAME/packeton.git
git checkout -b fix/patch-1
</code></pre>
<h3 id="3-install-the-dependencies"><a class="header" href="#3-install-the-dependencies">3. Install the dependencies</a></h3>
<p>Run composer install</p>
<pre><code>cd packeton
composer install
</code></pre>
<h3 id="4-configure-your-env-vars"><a class="header" href="#4-configure-your-env-vars">4. Configure your env vars.</a></h3>
<p>Create a file <code>.env.local</code> with following content.</p>
<pre><code># .env.local

APP_ENV=dev

# select database, default SQLite
DATABASE_URL=&quot;postgresql://postgres:123456@127.0.0.1:5432/packeton?serverVersion=12&amp;charset=utf8&quot;
</code></pre>
<h3 id="5-setup-database"><a class="header" href="#5-setup-database">5. Setup database</a></h3>
<pre><code>bin/console doctrine:schema:update --dump-sql --force
</code></pre>
<h3 id="6-run-local-webserver"><a class="header" href="#6-run-local-webserver">6. Run local webserver.</a></h3>
<pre><code>php -S localhost:8000 -t public/
</code></pre>
<h2 id="enjoy"><a class="header" href="#enjoy">ENJOY</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration-reference"><a class="header" href="#configuration-reference">Configuration Reference</a></h1>
<p>Full packeton configuration:</p>
<pre><code class="language-yaml">
packeton:
    github_no_api: '%env(bool:GITHUB_NO_API)%' # default true
    rss_max_items: 30
    archive: true
    
    anonymous_access: '%env(bool:PUBLIC_ACCESS)%' # default false
    anonymous_archive_access: '%env(bool:PUBLIC_ACCESS)%' # default false
    archive_options:
        format: zip
        basedir: '%env(resolve:PACKAGIST_DIST_PATH)%'
        endpoint: '%env(PACKAGIST_DIST_HOST)%' # default auto detect by host headers 
        include_archive_checksum: false

    jwt_authentication: # disable by default 
        algo: EdDSA
        private_key: '%kernel.project_dir%/var/jwt/eddsa-key.pem'
        public_key: '%kernel.project_dir%/var/jwt/eddsa-public.pem'
        passphrase: ~

    metadata:
        format: auto # Default, see about metadata.
        info_cmd_message: ~ # Bash logo, example - \u001b[37;44m#StandWith\u001b[30;43mUkraine\u001b[0m

    artifacts:
        support_types: ['gz', 'tar', 'tgz', 'zip']
        allowed_paths:
            - '/data/hdd1/composer'
        # Default path to storage/(local cache for S3) of uploaded artifacts
        artifact_storage: '%composer_home_dir%/artifact_storage'

    integrations: # See oauth2 integrations
        alias_name: # Alias name ()
            allow_login: true # default false 
            allow_register: false # default false 
            default_roles: ['ROLE_USER', 'ROLE_MAINTAINER', 'ROLE_GITLAB']
        
            clone_preference: 'api'
            repos_synchronization: true
        
            disable_hook_repos: false # disabled auto setup webhook
            disable_hook_org: false
            svg_logo: ~ # &lt;svg xmlns= logo
            logo: ~ # png logo
            login_title: Login or Register with GitHub
            description: ~
        
            login_control_expression: &quot;data['email'] ends with '@packeton.org'&quot; # Restrict logic/register by custom condition.
            login_control_expression_debug: false # help debugging    
        
            pull_request_review: true # Enable pull request composer.lock review. Default false
            webhook_url: ~ #overwrite host when setup webhooks
        
            github:
                client_id: 'xxx'
                client_secret: 'xxx'
    
            gitlab:
                client_id: 'xxx'
                client_secret: 'xxx'
                api_version: 'v4'
    
            githubapp:
                private_key: '%kernel.project_dir%/var/packeton-private-key.pem'
                passphrase: ~ # private key pass
                app_id: 345472

            gitea:
                client_id: '44000000-0000-0000-0000-00000000000'
                client_secret: 'gto_acxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'

            bitbucket:
                key: GA7000000000000000
                secret: 9chxxxxxzxxxxxxxxeexxxxxxxxxxxxx
                api_version: ~ # '/example/rest/v2/' custom api prefix

    # See mirrors section
    mirrors:
        packagist:
            url: https://repo.packagist.org
        orocrm:
            url: https://satis.oroinc.com/
            git_ssh_keys:
                git@github.com:oroinc: '/var/www/.ssh/private_key1'
                git@github.com:org2: '/var/www/.ssh/private_key2'
        example:
            url: https://satis.example.com/
            logo: 'https://example.com/logo.png'
            http_basic:
                username: 123
                password: 123
            public_access: true # Allow public access, default false
            sync_lazy: true # default false 
            enable_dist_mirror: false # default true
            available_package_patterns: # Additional restriction, but you can restrict it in UI
                - 'vend1/*'
            available_packages:
                - 'pack1/name1' # but you can restrict it in UI
            composer_auth: '{&quot;auth.json...&quot;}' # JSON. auth.json to pass composer opts.
            sync_interval: 3600 # default auto.
            info_cmd_message: &quot;\n\u001b[37;44m#Слава\u001b[30;43mУкраїні!\u001b[0m\n\u001b[40;31m#Смерть\u001b[30;41mворогам\u001b[0m&quot; # Info message

    web_protection:
        ## Multi host protection, disable web-ui if host !== app.example.com and ips != 127.0.0.1, 10.9.1.0/24
        ## But the repo metadata will be available for all hosts and ips.
        repo_hosts: ['*', '!app.example.com']
        allow_ips: '127.0.0.1, 10.9.1.0/24'
        status_code: 402
        custom_page: &gt; # Custom landing non-auth page. Path or HTML
            &lt;html&gt;
            &lt;head&gt;&lt;title&gt;402 Payment Required&lt;/title&gt;&lt;/head&gt;
            &lt;body&gt;
            &lt;center&gt;&lt;h1&gt;402 Payment Required&lt;/h1&gt;&lt;/center&gt;
            &lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
            &lt;/body&gt;
            &lt;/html&gt;

    web_protection:
        ## Disable web-ui for host = repo.example.com
        repo_hosts: ['repo.example.com']
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
