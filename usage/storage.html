<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>S3 Storage Provider - Packeton Docs</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="../index.html">Overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Setup</li><li class="chapter-item expanded "><a href="../installation.html">Installation</a></li><li class="chapter-item expanded "><a href="../installation-docker.html">Using docker</a></li><li class="chapter-item expanded "><a href="../reverse-proxy.html">Using a reverse proxy</a></li><li class="chapter-item expanded affix "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="../usage/index.html">Administration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/api.html">Admin API</a></li><li class="chapter-item expanded "><a href="../webhook.html">Outgoing Webhook</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../webhook.html">Intro</a></li><li class="chapter-item expanded "><a href="../webhook.html">Examples</a></li><li class="chapter-item expanded "><a href="../webhook/webhook-secrets.html">Secrets</a></li><li class="chapter-item expanded "><a href="../webhook/wh-security.html">Security Policy</a></li><li class="chapter-item expanded "><a href="../webhook/wh-test.html">Testing</a></li></ol></li><li class="chapter-item expanded "><a href="../usage/update-packages.html">Update Webhooks</a></li><li class="chapter-item expanded "><a href="../usage/customers.html">Customer Users</a></li><li class="chapter-item expanded "><a href="../usage/credential.html">SSH Credential</a></li><li class="chapter-item expanded "><a href="../usage/mirroring.html">Mirroring Packages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/mirroring.html">Configuration</a></li><li class="chapter-item expanded "><a href="../usage/mirroring.html">Strict mode</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../authentication.html">User Authentication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../authentication-jwt.html">JWT Configuration</a></li><li class="chapter-item expanded "><a href="../authentication-ldap.html">LDAP Configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../usage/storage.html" class="active">S3 Storage Provider</a></li><li class="chapter-item expanded "><a href="../usage/custom-page.html">Custom landing page</a></li><li class="chapter-item expanded "><a href="../usage/security-monitoring.html">Security Monitoring</a></li><li class="chapter-item expanded "><a href="../usage/migrate.html">Migrate from Satis</a></li><li class="chapter-item expanded "><a href="../oauth2.html">OAuth2 Integrations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pull-request-review.html">Pull Request review</a></li><li class="chapter-item expanded "><a href="../oauth2/github-oauth.html">GitHub Setup</a></li><li class="chapter-item expanded "><a href="../oauth2/githubapp.html">GitHub AppBot</a></li><li class="chapter-item expanded "><a href="../oauth2/gitlab-integration.html">GitLab Setup</a></li><li class="chapter-item expanded "><a href="../oauth2/gitea.html">Gitea Setup</a></li><li class="chapter-item expanded "><a href="../oauth2/bitbucket.html">Bitbucket Setup</a></li><li class="chapter-item expanded "><a href="../oauth2/oidc.html">OIDC</a></li><li class="chapter-item expanded "><a href="../oauth2/login-expression.html">Login Restriction</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Development</li><li class="chapter-item expanded "><a href="../dev/CONTRIBUTING.html">Contributing</a></li><li class="chapter-item expanded "><a href="../dev/configuration.html">Configuration Reference</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Packeton Docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/vtsykun/packeton" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/vtsykun/packeton/edit/master/docs/usage/storage.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="s3-storage-provider"><a class="header" href="#s3-storage-provider">S3 Storage Provider</a></h1>
<p>By default, Packeton stores packages archives on the local filesystem. But you can easily configure 
the S3 using <code>league/flysystem-bundle</code>.</p>
<p>For docker env, please set env vars. </p>
<pre><code>STORAGE_SOURCE=s3
STORAGE_AWS_BUCKET=packeton-bucket
STORAGE_AWS_PREFIX=packeton
STORAGE_AWS_ARTIFACT_PREFIX=artifact

STORAGE_AWS_ARGS='{&quot;endpoint&quot;: &quot;https://s3.waw.io.cloud.ovh.net&quot;, &quot;accessKeyId&quot;: &quot;xxx&quot;, &quot;accessKeySecret&quot;: &quot;xxx&quot;, &quot;region&quot;: &quot;waw&quot;}'
</code></pre>
<h2 id="irsa-iam-roles-for-service-accounts---ekskubernetes"><a class="header" href="#irsa-iam-roles-for-service-accounts---ekskubernetes">IRSA (IAM Roles for Service Accounts) - EKS/Kubernetes</a></h2>
<p>For Kubernetes/EKS deployments, you can use IRSA to authenticate without static credentials.
The pod's service account assumes an IAM role via web identity token.</p>
<h3 id="explicit-configuration"><a class="header" href="#explicit-configuration">Explicit Configuration</a></h3>
<pre><code>STORAGE_SOURCE=s3
STORAGE_AWS_BUCKET=packeton-bucket
STORAGE_AWS_ARGS='{&quot;region&quot;: &quot;us-east-1&quot;, &quot;roleArn&quot;: &quot;arn:aws:iam::123456789:role/packeton-s3-role&quot;, &quot;webIdentityTokenFile&quot;: &quot;/var/run/secrets/eks.amazonaws.com/serviceaccount/token&quot;}'
</code></pre>
<p>Configuration keys:</p>
<ul>
<li><code>roleArn</code> - ARN of the IAM role to assume</li>
<li><code>webIdentityTokenFile</code> - Path to the OIDC token file (injected by EKS)</li>
<li><code>roleSessionName</code> - Optional session identifier (defaults to <code>async-aws-*</code>)</li>
</ul>
<h3 id="auto-detection-via-environment-variables"><a class="header" href="#auto-detection-via-environment-variables">Auto-detection via Environment Variables</a></h3>
<p>AsyncAws automatically detects IRSA when standard AWS environment variables are set by EKS:</p>
<ul>
<li><code>AWS_WEB_IDENTITY_TOKEN_FILE</code></li>
<li><code>AWS_ROLE_ARN</code></li>
<li><code>AWS_REGION</code></li>
</ul>
<p>With IRSA properly configured on your EKS cluster, you may only need:</p>
<pre><code>STORAGE_SOURCE=s3
STORAGE_AWS_BUCKET=packeton-bucket
STORAGE_AWS_ARGS='{&quot;region&quot;: &quot;us-east-1&quot;}'
</code></pre>
<p>The SDK will automatically use the injected token file and role ARN from environment variables.</p>
<p>See <a href="https://async-aws.com/authentication.html">AsyncAws Authentication</a> for more details.</p>
<h2 id="mirror-storage-stateless-mode"><a class="header" href="#mirror-storage-stateless-mode">Mirror Storage (Stateless Mode)</a></h2>
<p>When <code>STORAGE_SOURCE=s3</code>, mirrored repositories metadata and zipballs are also stored in S3.
This enables running Packeton in stateless mode.</p>
<p>Additional env vars for mirror storage (optional):</p>
<pre><code># S3 prefixes for mirror data (defaults shown)
STORAGE_AWS_MIRROR_META_PREFIX=mirror-meta
STORAGE_AWS_MIRROR_DIST_PREFIX=mirror-dist

# Optional local cache directories. If empty, data is read/written directly to S3 (fully stateless).
# Set to /tmp paths for ephemeral caching in container environments.
MIRROR_METADATA_CACHE_DIR=
MIRROR_DIST_CACHE_DIR=
</code></pre>
<p>Example for fully stateless deployment:</p>
<pre><code>STORAGE_SOURCE=s3
STORAGE_AWS_BUCKET=my-bucket
MIRROR_METADATA_CACHE_DIR=
MIRROR_DIST_CACHE_DIR=
</code></pre>
<p>Example with ephemeral local cache (recommended for performance):</p>
<pre><code>STORAGE_SOURCE=s3
STORAGE_AWS_BUCKET=my-bucket
MIRROR_METADATA_CACHE_DIR=/tmp/mirror-meta
MIRROR_DIST_CACHE_DIR=/tmp/mirror-dist
</code></pre>
<p>Sometimes for Artifact Repository requires direct access to files from the archive, so to
improve performance and reduces count of S3 API requests, the all archives are cached on the local filesystem too. </p>
<p>If you need to use the other provider, like Google Cloud, you may add config file to <code>config/packages</code> or use <code>config.yaml</code> in data docker dir.</p>
<pre><code class="language-yaml">flysystem:
    storages:
        s3_v2.storage:
            adapter: 'asyncaws'
            options:
                client: 'packeton.s3.storage'
                bucket: '%env(STORAGE_AWS_BUCKET)%'
                prefix: '%env(STORAGE_AWS_PREFIX)%'

        s3_v2.artifact:
            adapter: 'asyncaws'
            options:
                client: 'packeton.s3.storage'
                bucket: '%env(STORAGE_AWS_BUCKET)%'
                prefix: '%env(STORAGE_AWS_ARTIFACT_PREFIX)%'

        gcloud.storage:
            adapter: 'gcloud'
            options:
                client: 'gcloud_client_service' 
                bucket: 'bucket_name'
                prefix: 'optional/path/prefix'

        gcloud.artifact:
            adapter: 'gcloud'
            options:
                client: 'gcloud_client_service' 
                bucket: 'bucket_name'
                prefix: 'optional/path/artifact'

parameters:
    env(STORAGE_AWS_BUCKET): 'packeton-bucket'
    env(STORAGE_AWS_PREFIX): 'packeton'
    env(STORAGE_AWS_ARGS): '[]'
    env(STORAGE_AWS_ARTIFACT_PREFIX): 'artifact'

services:
    packeton.s3.storage:
        class: AsyncAws\S3\S3Client
        arguments:
            $configuration: '%env(json:STORAGE_AWS_ARGS)%'
            $httpClient: '@Symfony\Contracts\HttpClient\HttpClientInterface'
            $logger: '@logger'
    
    gcloud_client_service:
        class: Google\Cloud\Storage\StorageClient
        arguments:
            - { keyFilePath: 'path/to/keyfile.json' }
</code></pre>
<pre><code>STORAGE_SOURCE=s3_v2
STORAGE_SOURCE=gcloud
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../authentication-ldap.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../usage/custom-page.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../authentication-ldap.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../usage/custom-page.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
